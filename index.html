<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MINDflow ‚Äì App</title>
  <style>
    :root{
      --bg:#000; --text:#fff; --dim:#cfcfd2;
      --panel:rgba(255,255,255,.05); --panel2:rgba(255,255,255,.1); --bd:rgba(255,255,255,.12);
      --p1:#FFB6C1; --p2:#FFDAB9; --p3:#9370DB; --ok:#68e365;
      --shadow:0 6px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;color:#fff;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
    .app{height:100%;max-width:390px;margin:0 auto;display:flex;flex-direction:column;border:1px solid #222;border-radius:25px;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);overflow:hidden}
    .topbar{padding:18px 16px 8px;text-align:center;border-bottom:1px solid #222;background:linear-gradient(135deg,#000,#1a1a1a)}
    .logo{font-size:28px;font-weight:800;background:linear-gradient(45deg,var(--p1),var(--p2),var(--p1));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .tag{font-size:12px;color:#9aa;font-style:italic;margin-top:4px}
    main{flex:1;overflow:auto;padding:18px 16px 110px}

    /* HOME centrata 2 colonne */
    .home-wrap{height:100%;display:grid;place-items:center}
    .home{display:grid;grid-template-columns:repeat(2,150px);grid-auto-rows:150px;gap:16px;place-content:center;place-items:center}
    .card{
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;
      width:150px;height:150px;border-radius:16px;border:1px solid var(--bd);
      color:#fff;text-align:center;cursor:pointer;transition:transform .18s ease;box-shadow:var(--shadow)
    }
    .card:focus-visible{outline:2px solid var(--p1);outline-offset:2px}
    .ic{font-size:28px}.tl{font-weight:700}.st{font-size:11px;opacity:.8}
    .career{background:linear-gradient(135deg,#1a1a2e,#16213e)}
    .emo{background:linear-gradient(135deg,#2d1b2e,#3e2640)}
    .fit{background:linear-gradient(135deg,#2e1f1a,#3e2a1b)}
    .spi{background:linear-gradient(135deg,#1a2e1f,#1b3e26)}
    .com{background:linear-gradient(135deg,#2e2a1a,#3e361b)}
    .pro{background:linear-gradient(135deg,#2e1a2a,#3e1b2f)}

    .view{display:none;animation:fade .24s ease}
    .view.active{display:block}
    .head{display:flex;align-items:center;gap:8px;margin-bottom:14px;padding:12px;background:var(--panel);border:1px solid var(--bd);border-radius:12px}
    .back{appearance:none;border:0;background:none;color:#ffd3dc;font-size:18px;cursor:pointer}
    .title{font-size:18px;font-weight:800}
    .ai{background:linear-gradient(135deg,var(--p1),var(--p2));color:#000;padding:12px;border-radius:12px;margin-bottom:12px;position:relative;font-style:italic}
    .ai:before{content:"ü§ñ";position:absolute;right:10px;top:-6px}
    .panel{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;background:var(--panel2);border-radius:8px;margin-top:8px}
    .in{width:100%;padding:8px;border-radius:8px;border:1px solid #333;color:#fff;background:rgba(255,255,255,.08)}
    .hint{font-size:11px;opacity:.7}

    .bottom{position:fixed;left:0;right:0;bottom:0;height:88px;background:linear-gradient(135deg,#111,#000);
      border-top:1px solid #222;display:flex;justify-content:center;align-items:center;
      padding-bottom:calc(env(safe-area-inset-bottom));z-index:10}
    .homebtn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;background:linear-gradient(135deg,var(--p1),var(--p2));border:0;cursor:pointer}
    .sys{position:absolute;right:20px;font-size:12px;color:#ffd3dc;background:rgba(255,182,193,.1);border:1px solid rgba(255,182,193,.35);padding:8px 12px;border-radius:12px;cursor:pointer}

    .jindi{position:fixed;right:18px;bottom:108px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px rgba(255,182,193,.35);cursor:pointer;z-index:20;animation:wave 2s infinite}
    .chat{position:fixed;right:18px;bottom:178px;width:300px;height:420px;display:none;z-index:25;background:rgba(0,0,0,.95);border:1px solid var(--p1);border-radius:15px;padding:12px;backdrop-filter:blur(10px)}
    .chat.active{display:block;animation:up .22s ease}
    .chathead{display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid #333}
    .msgs{height:300px;overflow:auto;margin:10px 0}
    .msg{max-width:80%;padding:8px 12px;border-radius:12px;margin-bottom:8px}
    .msg.ai{background:linear-gradient(135deg,var(--p1),var(--p2));color:#000}
    .msg.me{background:var(--panel2)}

    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
    @keyframes wave{0%,100%{transform:rotate(0)}25%{transform:rotate(12deg)}75%{transform:rotate(-12deg)}}
    @keyframes up{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

    /* planner */
    .slot{display:grid;grid-template-columns:66px 1fr 28px;gap:8px;align-items:center;margin:4px 0}
    .slot.done input[type="text"]{text-decoration:line-through;opacity:.6}
    .slot time{font-feature-settings:"tnum";font-variant-numeric:tabular-nums;color:#cbd}
    .check{appearance:none;width:22px;height:22px;border-radius:7px;border:1px solid #3a3a3a;background:var(--panel2);cursor:pointer}
    .slot.done .check{background:linear-gradient(135deg,#b1f8a2,#9df19b);border-color:#6dd86a}
    .goal-list li{margin:6px 0}
    canvas{width:100%;height:160px;border:1px solid #333;border-radius:8px;background:#0a0a0a}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="logo">MINDflow</div>
      <div class="tag">Il tuo viaggio verso la consapevolezza</div>
    </div>

    <main id="main">
      <!-- HOME -->
      <div class="home-wrap view active" id="home" aria-label="Home">
        <section class="home">
          <button class="card career" data-view="career"><div class="ic">üß†</div><div class="tl">Carriera</div><div class="st">Mindset</div></button>
          <button class="card emo" data-view="emotions"><div class="ic">ü©∑</div><div class="tl">Emozioni</div><div class="st">Equilibrio</div></button>
          <button class="card fit" data-view="fitness"><div class="ic">üí™üèº</div><div class="tl">Fitness</div><div class="st">Alimentazione</div></button>
          <button class="card spi" data-view="spirituality"><div class="ic">üîÆ</div><div class="tl">Spiritualit√†</div><div class="st">Crescita</div></button>
          <button class="card com" data-view="community"><div class="ic">ü´Ç</div><div class="tl">Community</div><div class="st">Connessioni</div></button>
          <button class="card pro" data-view="profile"><div class="ic">ü´Ü</div><div class="tl">Profilo</div><div class="st">Il tuo universo</div></button>
        </section>
      </div>

      <!-- CARRIERA -->
      <section id="career" class="view" aria-label="Carriera">
        <div class="head"><button class="back" data-back>‚Üê</button><div class="title">üß† Carriera & Mindset</div></div>
        <div class="ai">"Oggi √® il giorno perfetto per trasformare i tuoi sogni in realt√†. Jindi crede in te!"</div>

        <div class="panel">
          <h3>üìÖ Daily Planner (00:00 ‚Üí 24:00, slot 30‚Äô)</h3>
          <div class="row">
            <input id="pl-date" class="in" type="date">
            <span class="hint">Tocca ‚úÖ per completare</span>
          </div>
          <div id="slots"></div>
        </div>

        <div class="panel">
          <h3>üí∂ Calcolo Rapido</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <input id="hours" class="in" inputmode="decimal" placeholder="Ore" />
            <input id="rate" class="in" inputmode="decimal" placeholder="‚Ç¨/ora" />
            <div class="row"><span>Lordo</span><strong>‚Ç¨ <span id="gross">0.00</span></strong></div>
          </div>
        </div>

        <div class="panel">
          <h3>üéØ Obiettivi</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <div>
              <strong>Breve termine</strong>
              <ul id="goals-short" class="goal-list"></ul>
              <div style="display:flex;gap:6px">
                <input id="goal-short-in" class="in" placeholder="Es: pubblicare CV">
                <button id="goal-short-add" class="in" style="width:auto">+ Aggiungi</button>
              </div>
            </div>
            <div>
              <strong>Lungo termine</strong>
              <ul id="goals-long" class="goal-list"></ul>
              <div style="display:flex;gap:6px">
                <input id="goal-long-in" class="in" placeholder="Es: lanciare startup">
                <button id="goal-long-add" class="in" style="width:auto">+ Aggiungi</button>
              </div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>üéß Podcast & üìö Libri (vetrina)</h3>
          <div class="hint">Carica i tuoi contenuti e vendili con i piani qui sotto (vedi ‚ÄúProfilo ‚Üí Upgrade‚Äù). L‚ÄôAI pu√≤ generare descrizioni e copy.</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <input id="content-title" class="in" placeholder="Titolo o link esterno">
            <button id="content-ai" class="in" style="width:auto">Crea descrizione (AI)</button>
          </div>
          <div id="content-desc" class="in" style="margin-top:8px;background:rgba(255,255,255,.08)">‚Äî</div>
        </div>
      </section>

      <!-- EMOZIONI -->
      <section id="emotions" class="view" aria-label="Emozioni">
        <div class="head"><button class="back" data-back>‚Üê</button><div class="title">ü©∑ Emozioni</div></div>
        <div class="ai">"Le tue emozioni sono valide. Navighiamo insieme questo mare interiore."</div>

        <div class="panel">
          <h3>üòä Tracker Umore (con orario)</h3>
          <div style="display:grid;grid-template-columns:1fr 110px 100px;gap:8px">
            <div style="display:flex;gap:8px;justify-content:space-between">
              <button class="in" data-mood="üò¢" style="width:auto">üò¢</button>
              <button class="in" data-mood="üòê" style="width:auto">üòê</button>
              <button class="in" data-mood="üòä" style="width:auto">üòä</button>
              <button class="in" data-mood="üòÑ" style="width:auto">üòÑ</button>
              <button class="in" data-mood="ü§©" style="width:auto">ü§©</button>
            </div>
            <input id="emo-time" class="in" type="time">
            <button id="emo-add" class="in" style="width:auto">+ Registra</button>
          </div>
          <div style="margin-top:8px">
            Intensit√†: <input id="intensity" type="range" min="1" max="10" value="7" style="width:65%"> <strong><span id="intensity-val">7</span>/10</strong> ‚Äì Umore scelto: <strong><span id="mood-val">üòä</span></strong>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="emo-files" type="file" multiple accept="image/*,audio/*" class="in">
            <button id="emo-export" class="in" style="width:auto">Esporta .json</button>
          </div>
          <div id="emo-list" class="hint" style="margin-top:8px">0 registrazioni</div>
        </div>

        <div class="panel">
          <h3>üìà Grafici umore</h3>
          <div class="hint">Giornaliero (oggi) e media settimanale</div>
          <canvas id="chart-day" width="340" height="160"></canvas>
          <canvas id="chart-week" width="340" height="160" style="margin-top:8px"></canvas>
          <div class="hint" style="margin-top:6px">Per una condivisione reale con psicologo serve un backend (Supabase). Qui i dati restano solo sul tuo dispositivo.</div>
        </div>
      </section>

      <!-- FITNESS -->
      <section id="fitness" class="view" aria-label="Fitness e Alimentazione">
        <div class="head"><button class="back" data-back>‚Üê</button><div class="title">üí™üèº Fitness & Alimentazione</div></div>
        <div class="ai">"Il corpo √® il tempio dell‚Äôanima. Un passo alla volta!"</div>

        <div class="panel">
          <h3>üíß Contatori Giornalieri</h3>
          <div style="display:flex;gap:10px">
            <div class="panel" style="flex:1">
              <div>üíß Idratazione</div>
              <div style="font-size:24px;font-weight:800;margin:8px 0" id="water-count">0</div>
              <div><button data-counter="water" data-delta="-1">‚àí</button> <button data-counter="water" data-delta="1">+</button></div>
              <div class="hint">bicchieri</div>
            </div>
            <div class="panel" style="flex:1">
              <div>üö≠ Sigarette</div>
              <div style="font-size:24px;font-weight:800;margin:8px 0" id="cig-count">0</div>
              <div><button data-counter="cig" data-delta="-1">‚àí</button> <button data-counter="cig" data-delta="1">+</button></div>
              <div class="hint">oggi</div>
            </div>
            <div class="panel" style="flex:1">
              <div>üç∑ Alcol</div>
              <div style="font-size:24px;font-weight:800;margin:8px 0" id="alcohol-count">0</div>
              <div><button data-counter="alcohol" data-delta="-1">‚àí</button> <button data-counter="alcohol" data-delta="1">+</button></div>
              <div class="hint">unit√† oggi</div>
            </div>
          </div>
        </div>

        <div class="panel">
          <h3>üìè Dati personali</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input id="kg" class="in" inputmode="decimal" placeholder="Kg">
            <input id="cm-braccia" class="in" inputmode="decimal" placeholder="Braccia (cm)">
            <input id="cm-petto" class="in" inputmode="decimal" placeholder="Petto (cm)">
            <input id="cm-vita" class="in" inputmode="decimal" placeholder="Vita (cm)">
            <input id="cm-fianchi" class="in" inputmode="decimal" placeholder="Fianchi (cm)">
            <input id="cm-gambe" class="in" inputmode="decimal" placeholder="Gambe (cm)">
          </div>
        </div>

        <div class="panel">
          <h3>ü•ó Nutrizione & Kcal</h3>
          <div class="hint">Aggiungi pasti: colazione, spuntino, pranzo, merenda, cena, spuntino</div>
          <div style="display:grid;grid-template-columns:1fr 90px 90px;gap:8px;margin-top:8px">
            <input id="meal-name" class="in" placeholder="Es: Pranzo - riso + pollo">
            <input id="meal-kcal" class="in" inputmode="decimal" placeholder="Kcal">
            <button id="meal-add" class="in" style="width:auto">+ Aggiungi</button>
          </div>
          <div id="meals"></div>
          <div class="row"><strong>Totale Kcal oggi</strong><strong><span id="kcal-total">0</span></strong></div>
        </div>

        <div class="panel">
          <h3>üõí Ricette dal carrello (AI)</h3>
          <input id="ingr" class="in" placeholder="Scrivi ingredienti o incolla lista (es: uova, cipolle, tonno)">
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="photo" type="file" accept="image/*" class="in" style="flex:1">
            <button id="recipe-btn" class="in" style="width:auto;cursor:pointer">Suggerisci ricette (AI)</button>
          </div>
          <div id="recipe-out" class="in" style="margin-top:8px;background:rgba(255,255,255,.08)">‚Äî</div>
          <div class="hint">Per OCR foto servirebbe un servizio esterno; qui l‚ÄôAI usa solo il testo degli ingredienti.</div>
        </div>

        <div class="panel">
          <h3>üèãÔ∏è‚Äç‚ôÄÔ∏è Workout (AI)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input id="wk-goal" class="in" placeholder="Obiettivo (es: Forza, Definizione)">
            <input id="wk-days" class="in" placeholder="Giorni a settimana (es: 3)">
          </div>
          <button id="wk-btn" class="in" style="margin-top:8px;width:auto;cursor:pointer">Genera piano</button>
          <div id="wk-out" class="in" style="margin-top:8px;background:rgba(255,255,255,.08)">‚Äî</div>
        </div>
      </section>

      <!-- SPIRITUALIT√Ä -->
      <section id="spirituality" class="view" aria-label="Spiritualit√†">
        <div class="head"><button class="back" data-back>‚Üê</button><div class="title">üîÆ Spiritualit√†</div></div>
        <div class="ai" style="background:linear-gradient(135deg,var(--p3),var(--p1))">"Le stelle ti sussurrano: oggi √® giorno di trasformazione."</div>
        <div class="panel" style="text-align:center">
          <h3>üßò‚Äç‚ôÄÔ∏è Meditazione Guidata</h3>
          <div id="med-timer" style="font-size:32px;font-weight:800;color:var(--p1);margin:8px 0">05:00</div>
          <button id="med-toggle" class="in" style="cursor:pointer;width:auto">‚ñ∂Ô∏è Avvia/Metti in pausa</button>
        </div>

        <div class="panel">
          <h3>üßø Tema natale (AI)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px">
            <input id="astro-date" class="in" type="date" value="2004-07-10">
            <input id="astro-time" class="in" type="time" value="05:00">
            <input id="astro-place" class="in" placeholder="Citt√†, (Provincia)" value="Broni,(PV)">
          </div>
          <button id="astro-btn" class="in" style="margin-top:8px;width:auto;cursor:pointer">Analizza influenza su azioni & umore</button>
          <div id="astro-out" class="in" style="margin-top:8px;background:rgba(255,255,255,.08)">‚Äî</div>
          <div class="hint">Per un tema natale astronomicamente preciso serve un‚ÄôAPI di effemeridi; qui l‚ÄôAI crea una lettura personalizzata dai tuoi dati.</div>
        </div>
      </section>

      <!-- COMMUNITY -->
      <section id="community" class="view" aria-label="Community">
        <div class="head"><button class="back" data-back>‚Üê</button><div class="title">ü´Ç Community</div></div>
        <div class="ai">"Insieme siamo pi√π forti!"</div>

        <div class="panel">
          <h3>‚ú® Condividi il tuo momento</h3>
          <textarea rows="3" class="in" id="post-text" placeholder="Cosa stai pensando oggi?"></textarea>
          <div class="row">
            <span>Allega üì∑ üéØ üí° (locale)</span>
            <button id="post-btn" class="in" style="width:auto;cursor:pointer">Pubblica</button>
          </div>
        </div>

        <div class="panel" id="feed">
          <h3>üì∞ Feed</h3>
          <div class="hint">I post sono salvati localmente sul tuo dispositivo.</div>
        </div>
      </section>

      <!-- PROFILO -->
      <section id="profile" class="view" aria-label="Profilo">
        <div class="head"><button class="back" data-back>‚Üê</button><div class="title">ü´Ü Profilo</div></div>
        <div class="ai">"Il tuo profilo √® la mappa del tuo universo."</div>

        <div class="panel">
          <h3>üë§ Info</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input class="in" value="Alessandro" placeholder="Nome">
            <input class="in" value="Rossi" placeholder="Cognome">
            <input class="in" value="alex@mindflow.app" placeholder="Email">
            <input class="in" type="date" value="1995-03-15">
          </div>
        </div>

        <div class="panel">
          <h3>üîî Notifiche</h3>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox" checked> üß† Carriera</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox"> ü©∑ Emozioni</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox" checked> üí™üèº Fitness</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox" checked> üîÆ Spiritualit√†</label>
        </div>

        <div class="panel">
          <h3>üíé Upgrade piano (Stripe)</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <a class="in" style="width:auto" target="_blank" href="https://buy.stripe.com/cNicN53Lp5WW46y6Y1d0Q03">üå∏ Boccioli ‚Ç¨7,99/mese</a>
            <a class="in" style="width:auto" target="_blank" href="https://buy.stripe.com/5kQeVd6XBCLj8W05TXd0Q04">üíê Fiori ‚Ç¨12,99/mese</a>
            <a class="in" style="width:auto" target="_blank" href="https://buy.stripe.com/00w7sL3Lpclj3Cucild0Q05">üå≥ Premium ‚Ç¨149,99/mese</a>
          </div>
          <div class="hint">Pagamento sicuro su Stripe. Torna qui dopo il pagamento.</div>
        </div>

        <div class="panel">
          <h3>üé• Live (prossimamente)</h3>
          <div class="hint">Mindset, business, meditazione‚Ä¶ Integreremo un provider live (es. Livepeer/Mux) quando vuoi.</div>
        </div>
      </section>
    </main>

    <nav class="bottom" aria-label="Navigazione">
      <button class="homebtn" id="go-home" aria-label="Home">üè†</button>
      <button class="sys" id="open-system" aria-haspopup="dialog">Sistema ‚öôÔ∏è</button>
    </nav>
  </div>

  <!-- Bolla Jindi -->
  <button class="jindi" id="jindi" aria-controls="chat" aria-expanded="false">üëã</button>

  <!-- Chat -->
  <section class="chat" id="chat" aria-live="polite" aria-label="Chat con Jindi">
    <div class="chathead">
      <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center">üëã</div>
      <div><strong>Jindi AI</strong><div style="font-size:10px;opacity:.7">Il tuo assistente</div></div>
      <button id="close-chat" style="margin-left:auto;background:none;border:0;color:#ccc;font-size:18px">√ó</button>
    </div>
    <div class="msgs" id="msgs"><div class="msg ai">Ciao! Come posso aiutarti oggi? üåü</div></div>
    <input id="chat-in" class="in" placeholder="Scrivi a Jindi‚Ä¶" />
  </section>

  <script>
    // ================== helpers & storage ==================
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
    const LS = {
      get:(k,d)=>{ try{ return JSON.parse(localStorage.getItem(k)) ?? d }catch{ return d }},
      set:(k,v)=>localStorage.setItem(k, JSON.stringify(v))
    };

    // ================== router ==================
    const views = ["home","career","emotions","fitness","spirituality","community","profile"];
    function show(v){ views.forEach(x=>$("#"+x).classList.toggle("active", x===v)); location.hash="#"+v; }
    window.addEventListener("hashchange", ()=>{ const v=(location.hash||"#home").slice(1); show(views.includes(v)?v:"home"); });
    $$("#home .card").forEach(b=>b.addEventListener("click", ()=>show(b.dataset.view)));
    $$("[data-back]").forEach(b=>b.addEventListener("click", ()=>history.back()));
    $("#go-home").addEventListener("click", ()=>show("home"));
    $("#open-system").addEventListener("click", ()=>alert("Impostazioni, Backup locale, Supporto, Info App"));

    // ================== Planner 00:00 - 24:00 ==================
    const plDate=$("#pl-date"), slotsEl=$("#slots");
    function todayISO(){ const d=new Date(); d.setMinutes(d.getMinutes()-d.getTimezoneOffset()); return d.toISOString().slice(0,10); }
    function genTimes(){
      const out=[]; for(let h=0;h<24;h++){ for(let m of [0,30]){ out.push(`${String(h).padStart(2,"0")}:${String(m).padStart(2,"0")}`); } }
      return out;
    }
    function loadDay(date){
      slotsEl.innerHTML="";
      const data=LS.get("planner-"+date,{});
      genTimes().forEach(t=>{
        const row=document.createElement("div"); row.className="slot"+(data[t]?.done?" done":"");
        row.innerHTML=`<time>${t}</time><input type="text" class="in" value="${(data[t]?.task||"").replace(/"/g,'&quot;')}" placeholder="Aggiungi azione‚Ä¶"><button class="check" title="Completa"></button>`;
        const input=row.querySelector("input"); const check=row.querySelector(".check");
        input.addEventListener("change",()=>{ data[t]={...(data[t]||{}),task:input.value}; LS.set("planner-"+date,data); });
        check.addEventListener("click",()=>{ data[t]={...(data[t]||{}),done:!(data[t]?.done)}; row.classList.toggle("done",data[t].done); LS.set("planner-"+date,data); });
        slotsEl.appendChild(row);
      });
    }
    plDate.value = todayISO();
    loadDay(plDate.value);
    plDate.addEventListener("change",()=>loadDay(plDate.value));

    // ================== Calcolo rapido ==================
    const hours=$("#hours"), rate=$("#rate"), gross=$("#gross");
    function calc(){ const h=parseFloat(hours?.value||0)||0; const r=parseFloat(rate?.value||0)||0; const g=h*r; gross.textContent=g.toFixed(2); }
    hours?.addEventListener("input", calc); rate?.addEventListener("input", calc);

    // ================== Obiettivi ==================
    const GS=LS.get("goals-short",[]), GL=LS.get("goals-long",[]);
    function renderGoals(){
      $("#goals-short").innerHTML = GS.map((g,i)=>`<li>${g} <a href="#" data-gs="${i}">‚úñ</a></li>`).join("")||"<div class='hint'>Nessun obiettivo breve</div>";
      $("#goals-long").innerHTML  = GL.map((g,i)=>`<li>${g} <a href="#" data-gl="${i}">‚úñ</a></li>`).join("") ||"<div class='hint'>Nessun obiettivo lungo</div>";
      $$("[data-gs]").forEach(a=>a.onclick=()=>{GS.splice(+a.dataset.gs,1);LS.set("goals-short",GS);renderGoals();});
      $$("[data-gl]").forEach(a=>a.onclick=()=>{GL.splice(+a.dataset.gl,1);LS.set("goals-long",GL);renderGoals();});
    }
    $("#goal-short-add").onclick=()=>{ const v=$("#goal-short-in").value.trim(); if(v){GS.push(v);LS.set("goals-short",GS);$("#goal-short-in").value="";renderGoals();}};
    $("#goal-long-add").onclick =()=>{ const v=$("#goal-long-in").value.trim();  if(v){GL.push(v);LS.set("goals-long",GL); $("#goal-long-in").value=""; renderGoals();}};
    renderGoals();

    // ================== Podcast/Libri (AI copy) ==================
    $("#content-ai").onclick = async ()=>{
      const title = $("#content-title").value.trim(); if(!title) return alert("Scrivi un titolo/link");
      $("#content-desc").textContent="Sto creando il copy‚Ä¶";
      try{
        const r=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:`Scrivi una descrizione persuasiva (max 120 parole) per questo contenuto: "${title}". Stile empatico, chiaro, con invito all'azione.`})});
        const j=await r.json(); $("#content-desc").textContent=j.reply||"‚Äî";
      }catch{ $("#content-desc").textContent="Ops, non riesco ora üôè"; }
    };

    // ================== Emozioni ==================
    const moodVal=$("#mood-val"), intensity=$("#intensity"), intensityVal=$("#intensity-val"), emoTime=$("#emo-time");
    const emoKey = "emotions-entries";
    function nowHHMM(){ const d=new Date(); return `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`; }
    emoTime.value = nowHHMM();
    $$("[data-mood]").forEach(btn=>btn.addEventListener("click", ()=>{ moodVal.textContent=btn.dataset.mood; }));
    intensity.addEventListener("input", e=>{ intensityVal.textContent=e.target.value; });
    $("#emo-add").onclick = ()=>{
      const entries = LS.get(emoKey,[]);
      entries.push({date:todayISO(), time: emoTime.value||nowHHMM(), mood: moodVal.textContent, intensity:+intensity.value});
      LS.set(emoKey,entries); $("#emo-list").textContent = `${entries.length} registrazioni`; drawCharts();
    };
    $("#emo-files").addEventListener("change", e=>{
      const files=[...e.target.files]; if(!files.length) return;
      alert(`${files.length} file aggiunti (solo in locale).`);
    });
    $("#emo-export").onclick = ()=>{
      const data = LS.get(emoKey,[]);
      const blob = new Blob([JSON.stringify(data,null,2)], {type:"application/json"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="emozioni.json"; a.click();
    };
    $("#emo-list").textContent = `${LS.get(emoKey,[]).length} registrazioni`;

    // charts (semplice canvas)
    function drawLine(ctx,points,color){ ctx.beginPath(); points.forEach((p,i)=>{ if(i) ctx.lineTo(p.x,p.y); else ctx.moveTo(p.x,p.y); }); ctx.strokeStyle=color; ctx.lineWidth=2; ctx.stroke(); }
    function drawAxes(ctx){ ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height); ctx.strokeStyle="#333"; ctx.lineWidth=1; ctx.strokeRect(30,10,ctx.canvas.width-40,ctx.canvas.height-30); }
    function drawCharts(){
      const entries=LS.get(emoKey,[]).filter(e=>e.date===todayISO()).sort((a,b)=>a.time.localeCompare(b.time));
      const c1=$("#chart-day"), ctx1=c1.getContext("2d"); drawAxes(ctx1);
      if(entries.length){
        const W=c1.width-40, H=c1.height-30, X0=30, Y0=10;
        const pts=entries.map((e,i)=>({ x:X0 + (i/(Math.max(entries.length-1,1)))*W, y:Y0 + (1 - (e.intensity-1)/9)*H }));
        drawLine(ctx1,pts,"#ffb6c1");
      }else{ ctx1.fillStyle="#888"; ctx1.fillText("Nessun dato oggi", 40, 90); }

      const c2=$("#chart-week"), ctx2=c2.getContext("2d"); drawAxes(ctx2);
      // media 7 giorni
      const map={}; for(let i=0;i<7;i++){ const d=new Date(); d.setDate(d.getDate()-i); const k=d.toISOString().slice(0,10); map[k]=[]; }
      LS.get(emoKey,[]).forEach(e=>{ if(map[e.date]) map[e.date].push(e.intensity); });
      const keys=Object.keys(map).sort(); const avg=keys.map(k=> (map[k].length? map[k].reduce((a,b)=>a+b)/map[k].length : 0));
      if(avg.some(v=>v>0)){
        const W2=c2.width-40,H2=c2.height-30,X02=30,Y02=10;
        const pts2=avg.map((v,i)=>({x:X02+(i/(avg.length-1))*W2, y:Y02+(1-(v/10))*H2 }));
        drawLine(ctx2,pts2,"#ffdAB9");
      }else{ ctx2.fillStyle="#888"; ctx2.fillText("Nessun dato ultimi 7 giorni", 40, 90); }
    }
    drawCharts();

    // ================== Contatori (con alcol) ==================
    const counters={water:$("#water-count"), cig:$("#cig-count"), alcohol:$("#alcohol-count")};
    $$("[data-counter]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const n=btn.dataset.counter; const d=parseInt(btn.dataset.delta,10);
        const el=counters[n]; let v=parseInt(el.textContent||"0",10)+d; el.textContent=Math.max(0,v);
      });
    });

    // ================== Nutrizione ==================
    const mealsEl=$("#meals"), kcalTotal=$("#kcal-total");
    function loadMeals(){ const arr=LS.get("meals-"+todayISO(),[]); renderMeals(arr); }
    function renderMeals(arr){
      mealsEl.innerHTML = arr.map((m,i)=>`<div class="row"><span>${m.name}</span><strong>${m.kcal} kcal</strong> <a href="#" data-del="${i}">‚úñ</a></div>`).join("") || "<div class='hint'>Nessun pasto</div>";
      kcalTotal.textContent = arr.reduce((s,m)=>s+(+m.kcal||0),0);
      $$("[data-del]").forEach(a=>a.onclick=()=>{ const x=LS.get("meals-"+todayISO(),[]); x.splice(+a.dataset.del,1); LS.set("meals-"+todayISO(),x); renderMeals(x); });
    }
    $("#meal-add").onclick=()=>{ const name=$("#meal-name").value.trim(), kcal=+($("#meal-kcal").value||0); if(!name) return;
      const arr=LS.get("meals-"+todayISO(),[]); arr.push({name,kcal}); LS.set("meals-"+todayISO(),arr); $("#meal-name").value=""; $("#meal-kcal").value=""; renderMeals(arr);
    };
    loadMeals();

    // ================== Ricette AI ==================
    $("#recipe-btn")?.addEventListener("click", async ()=>{
      const ingredients=$("#ingr")?.value||"";
      $("#recipe-out").textContent="Sto pensando a ricette‚Ä¶";
      try{
        const r=await fetch("/api/recipes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ingredients})});
        if(!r.ok) throw new Error(await r.text());
        const {text}=await r.json();
        $("#recipe-out").innerHTML=text?.replace(/\n/g,"<br>")||"‚Äî";
      }catch(e){ console.error(e); $("#recipe-out").textContent="Ops, non riesco ora üôè"; }
    });

    // ================== Workout AI ==================
    $("#wk-btn")?.addEventListener("click", async ()=>{
      const goal=$("#wk-goal")?.value||""; const days=$("#wk-days")?.value||"";
      $("#wk-out").textContent="Creo il piano‚Ä¶";
      try{
        const r=await fetch("/api/workout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({goal,days})});
        if(!r.ok) throw new Error(await r.text());
        const {text}=await r.json();
        $("#wk-out").innerHTML=text?.replace(/\n/g,"<br>")||"‚Äî";
      }catch(e){ console.error(e); $("#wk-out").textContent="Ops, non riesco ora üôè"; }
    });

    // ================== Meditazione ==================
    const medBtn=$("#med-toggle"), medTimer=$("#med-timer"); let secs=5*60, iv=null;
    function rend(){const m=Math.floor(secs/60), s=secs%60; medTimer.textContent=String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");}
    function start(){ if(iv) return; iv=setInterval(()=>{ if(secs>0){secs--;rend();}else{stop();secs=5*60;rend();alert("Meditazione completata ‚ú®");}},1000); }
    function stop(){ clearInterval(iv); iv=null; }
    medBtn?.addEventListener("click", ()=> iv?stop():start()); rend();

    // ================== Tema natale AI ==================
    $("#astro-btn")?.addEventListener("click", async ()=>{
      const date=$("#astro-date")?.value||""; const time=$("#astro-time")?.value||""; const place=$("#astro-place")?.value||"";
      $("#astro-out").textContent="Sto analizzando‚Ä¶";
      try{
        const r=await fetch("/api/astro",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date,time,place})});
        if(!r.ok) throw new Error(await r.text());
        const {text}=await r.json();
        $("#astro-out").textContent=text||"‚Äî";
      }catch(e){ console.error(e); $("#astro-out").textContent="Ops, non riesco ora üôè"; }
    });

    // ================== Community (locale) ==================
    function loadFeed(){ const arr=LS.get("feed",[]); $("#feed").innerHTML = `<h3>üì∞ Feed</h3>` + (arr.map(p=>`<div class="row"><span>@Tu</span><span>${p}</span></div>`).join("") || "<div class='hint'>Ancora nessun post</div>"); }
    $("#post-btn").onclick=()=>{ const t=$("#post-text").value.trim(); if(!t) return; const arr=LS.get("feed",[]); arr.unshift(t); LS.set("feed",arr); $("#post-text").value=""; loadFeed(); };
    loadFeed();

    // ================== Chat AI (Jindi) ==================
    const bubble=$("#jindi"), chat=$("#chat"), closeChat=$("#close-chat"), input=$("#chat-in"), msgs=$("#msgs");
    function toggleChat(open){ const isOpen=open??!chat.classList.contains("active"); chat.classList.toggle("active", isOpen); bubble.setAttribute("aria-expanded", String(isOpen)); if(isOpen) input.focus(); }
    bubble.addEventListener("click", ()=>toggleChat()); closeChat.addEventListener("click", ()=>toggleChat(false));
    function addMsg(text, who="ai"){ const d=document.createElement("div"); d.className="msg "+who; d.textContent=text; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; }
    async function generateAIResponse(userMessage){
      try{
        const r = await fetch("/api/chat", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ message: userMessage }) });
        if(!r.ok) throw new Error(await r.text());
        const data = await r.json();
        return data.reply || "Sto riflettendo‚Ä¶ ‚ú®";
      }catch(e){ console.error(e); return "Ops, non riesco a rispondere ora. Riprova tra poco üôè"; }
    }
    input.addEventListener("keydown", async e=>{
      if(e.key==="Enter"){
        const text=input.value.trim(); if(!text) return;
        addMsg(text,"me"); input.value="";
        const reply = await generateAIResponse(text);
        addMsg(reply,"ai");
      }
    });

    // start
    show((location.hash||"#home").slice(1));
  </script>
</body>
</html>