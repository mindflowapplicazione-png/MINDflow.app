<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>MINDflow ‚Äî Profilo & Piani</title>
<style>
  :root{--bg:#000;--panel:#111;--ring:#2a2a2a;--muted:#8b8b8b;--rose1:#ffc0cb;--rose2:#f6bfcf}
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:#fff;font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Arial,sans-serif}
  .wrap{max-width:420px;margin:0 auto;padding:20px}
  .header{text-align:center;margin-bottom:16px}
  .header h1{font-size:28px;color:#FFB6C1;margin:4px 0}
  .header p{color:var(--muted);font-style:italic;font-size:13px}
  .back{display:flex;align-items:center;gap:8px;background:#1a1a1a;border-radius:14px;padding:14px;margin:10px 0 16px;text-decoration:none;color:#fff;font-weight:700}
  .section{background:#121212;border:1px solid var(--ring);border-radius:14px;padding:14px;margin:12px 0}
  .title{font-weight:800;margin-bottom:10px;font-size:16px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .plan{background:linear-gradient(135deg,var(--rose1),var(--rose2));color:#000;border-radius:16px;padding:14px;font-weight:800;cursor:pointer;display:flex;flex-direction:column;gap:6px;min-height:90px}
  .muted{color:#bbb;font-size:12px}
  .btn{background:linear-gradient(135deg,var(--rose1),var(--rose2));color:#000;border:0;border-radius:14px;padding:10px 14px;font-weight:800;cursor:pointer}
  .row{display:flex;gap:8px;align-items:center}
  .card{background:#141414;border:1px solid #282828;border-radius:14px;padding:12px;margin:8px 0}
  input,select{width:100%;background:#1b1b1b;border:1px solid #333;color:#fff;border-radius:12px;padding:10px;font-size:14px}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <h1>MINDflow</h1>
    <p>Il tuo viaggio verso la consapevolezza</p>
  </div>
  <a class="back" href="./index.html">‚Üê üîê Profilo</a>

  <div class="section">
    <div class="title">üë§ Dati utente</div>
    <div class="card">
      <div class="row">
        <input id="email" type="email" placeholder="Email (usata per abbonamento)">
        <button class="btn" onclick="saveEmail()">Salva</button>
      </div>
      <div class="muted" id="emailInfo"></div>
    </div>
  </div>

  <div class="section">
    <div class="title">üíé Piani & Upgrade</div>
    <div class="grid3">
      <button class="plan" onclick="startCheckout('boccioli')">üå± Boccioli<br><span class="muted">‚Ç¨7,99/m</span></button>
      <button class="plan" onclick="startCheckout('fiori')">üå∏ Fiori<br><span class="muted">‚Ç¨12,99/m</span></button>
      <button class="plan" onclick="startCheckout('premium')">üíé Premium<br><span class="muted">‚Ç¨149,99/m</span></button>
    </div>
    <div class="row" style="margin-top:12px">
      <button class="btn" onclick="openPortal()">Gestisci abbonamento</button>
      <button class="btn" onclick="checkStatus()">Verifica stato</button>
    </div>
    <div id="statusBox" class="card" style="display:none"></div>
  </div>

  <div class="section">
    <div class="title">‚öôÔ∏è Preferenze</div>
    <div class="row">
      <select id="theme">
        <option value="dark" selected>Tema: Scuro</option>
        <option value="light">Tema: Chiaro</option>
      </select>
      <button class="btn" onclick="savePrefs()">Salva</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG FALLBACK (usa i tuoi link diretti se le API non sono configurate) ===== */
const DIRECT_CHECKOUT = {
  boccioli: "https://buy.stripe.com/00w7sL3Lpclj3CucildQQ05",
  fiori:    "https://buy.stripe.com/5kQeVd6XBclj8WO5TXdQQ04",
  premium:  "https://buy.stripe.com/cNicN53Lp5WV4Gy6Y1dQQ03"
};

function getEmail(){ return localStorage.getItem('mf_email') || ''; }
function saveEmail(){
  const v = document.getElementById('email').value.trim();
  if(!v) return alert("Inserisci un'email");
  localStorage.setItem('mf_email', v);
  document.getElementById('emailInfo').textContent = "Email salvata: " + v;
}
function savePrefs(){
  localStorage.setItem('mf_theme', document.getElementById('theme').value);
  alert('Preferenze salvate');
}
document.getElementById('email').value = getEmail();
document.getElementById('emailInfo').textContent = getEmail() ? "Email salvata: " + getEmail() : "Suggerimento: salva l'email per associare l'abbonamento.";

/* ===== CHECKOUT ===== */
async function startCheckout(plan){
  const email = getEmail();
  if(!email) { if(!confirm("Procedere senza email salvata?")) return; }

  try{
    // Prova la route serverless: se fallisce, usa i link diretti
    const res = await fetch(`/api/checkout?plan=${encodeURIComponent(plan)}&email=${encodeURIComponent(email||'')}`, { method:'POST' });
    if(res.ok){
      const { url } = await res.json();
      if(url) { window.location.href = url; return; }
    }
    // fallback
    window.location.href = DIRECT_CHECKOUT[plan];
  }catch(e){
    // fallback duro
    window.location.href = DIRECT_CHECKOUT[plan];
  }
}

/* ===== CUSTOMER PORTAL ===== */
async function openPortal(){
  const email = getEmail();
  if(!email){ alert("Inserisci e salva la tua email per aprire il Portale clienti."); return; }
  try{
    const res = await fetch(`/api/portal?email=${encodeURIComponent(email)}`, { method:'POST' });
    const data = await res.json();
    if(data.url) window.location.href = data.url; else alert('Impossibile aprire il portale.');
  }catch(e){ alert('Portale non configurato.'); }
}

/* ===== STATO LOCALE (senza backend) ===== */
function checkStatus(){
  const box = document.getElementById('statusBox');
  const sub = JSON.parse(localStorage.getItem('mf_subscription') || '{}');
  if(!sub.plan){ box.style.display='block'; box.innerHTML = "Nessun abbonamento registrato in locale.<br><span class='muted'>Dopo il pagamento, il server aggiorner√† lo stato.</span>"; return; }
  box.style.display='block';
  box.innerHTML = `<strong>Piano:</strong> ${sub.plan}<br><strong>Stato:</strong> ${sub.status}<br><span class='muted'>Aggiornato: ${sub.updated_at||'‚Äî'}</span>`;
}
</script>
</body>
</html>
