<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>MINDflow â€“ App</title>
  <style>
    :root{
      --bg:#000; --text:#fff; --dim:#cfcfd2;
      --panel:rgba(255,255,255,.05); --panel2:rgba(255,255,255,.1); --bd:rgba(255,255,255,.12);
      --p1:#FFB6C1; --p2:#FFDAB9; --p3:#9370DB;
      --shadow:0 6px 24px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:#000;color:#fff;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
    .app{height:100%;max-width:390px;margin:0 auto;display:flex;flex-direction:column;border:1px solid #222;border-radius:25px;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);overflow:hidden}
    .topbar{padding:18px 16px;text-align:center;border-bottom:1px solid #222;background:linear-gradient(135deg,#000,#1a1a1a)}
    .logo{font-size:28px;font-weight:800;background:linear-gradient(45deg,var(--p1),var(--p2),var(--p1));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
    .tag{font-size:12px;color:#9aa;font-style:italic;margin-top:4px}
    main{flex:1;overflow:auto;padding:18px 16px 100px}

    /* HOME centrata 2 colonne */
    .home-wrap{height:100%;display:grid;place-items:center}
    .home{display:grid; grid-template-columns:repeat(2,150px); grid-auto-rows:150px; gap:16px; place-content:center; place-items:center}
    .card{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
      width:150px; height:150px; border-radius:16px; border:1px solid var(--bd);
      color:#fff; text-align:center; cursor:pointer; transition:transform .18s ease; box-shadow:var(--shadow)
    }
    .ic{font-size:28px}.tl{font-weight:700}.st{font-size:11px;opacity:.8}
    .career{background:linear-gradient(135deg,#1a1a2e,#16213e)}
    .emo{background:linear-gradient(135deg,#2d1b2e,#3e2640)}
    .fit{background:linear-gradient(135deg,#2e1f1a,#3e2a1b)}
    .spi{background:linear-gradient(135deg,#1a2e1f,#1b3e26)}
    .com{background:linear-gradient(135deg,#2e2a1a,#3e361b)}
    .pro{background:linear-gradient(135deg,#2e1a2a,#3e1b2f)}

    .view{display:none;animation:fade .24s ease}
    .view.active{display:block}
    .head{display:flex;align-items:center;gap:8px;margin-bottom:14px;padding:12px;background:var(--panel);border:1px solid var(--bd);border-radius:12px}
    .back{appearance:none;border:0;background:none;color:#FFB6C1;font-size:18px;cursor:pointer}
    .title{font-size:18px;font-weight:800}
    .ai{background:linear-gradient(135deg,var(--p1),var(--p2));color:#000;padding:12px;border-radius:12px;margin-bottom:12px;position:relative;font-style:italic}
    .ai:before{content:"ğŸ¤–";position:absolute;right:10px;top:-6px}
    .panel{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;background:var(--panel2);border-radius:8px;margin-top:8px}
    .in{width:100%;padding:8px;border-radius:8px;border:1px solid #333;color:#fff;background:rgba(255,255,255,.08)}
    .tiny{font-size:11px;opacity:.7}

    .bottom{position:fixed;left:0;right:0;bottom:0;height:80px;background:linear-gradient(135deg,#111,#000);border-top:1px solid #222;display:flex;justify-content:center;align-items:center;padding-bottom:calc(env(safe-area-inset-bottom));z-index:10}
    .homebtn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;background:linear-gradient(135deg,var(--p1),var(--p2));border:0;cursor:pointer}
    .sys{position:absolute;right:20px;font-size:12px;color:#FFB6C1;background:rgba(255,182,193,.1);border:1px solid rgba(255,182,193,.35);padding:8px 12px;border-radius:12px;cursor:pointer}

    .jindi{position:fixed;right:18px;bottom:100px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px rgba(255,182,193,.35);cursor:pointer;z-index:20;animation:wave 2s infinite}
    .chat{position:fixed;right:18px;bottom:170px;width:300px;height:400px;display:none;z-index:25;background:rgba(0,0,0,.95);border:1px solid var(--p1);border-radius:15px;padding:12px;backdrop-filter:blur(10px)}
    .chat.active{display:block;animation:up .22s ease}
    .chathead{display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid #333}
    .msgs{height:280px;overflow:auto;margin:10px 0}
    .msg{max-width:80%;padding:8px 12px;border-radius:12px;margin-bottom:8px}
    .msg.ai{background:linear-gradient(135deg,var(--p1),var(--p2));color:#000}
    .msg.me{background:var(--panel2)}

    @media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
    @keyframes wave{0%,100%{transform:rotate(0)}25%{transform:rotate(12deg)}75%{transform:rotate(-12deg)}}
    @keyframes up{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
    @keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="app">
    <!-- rimossa status bar -->
    <div class="topbar">
      <div class="logo">MINDflow</div>
      <div class="tag">Il tuo viaggio verso la consapevolezza</div>
    </div>

    <main id="main">
      <!-- HOME -->
      <div class="home-wrap view active" id="home" aria-label="Home">
        <section class="home">
          <button class="card career" data-view="career"><div class="ic">ğŸ§ </div><div class="tl">Carriera</div><div class="st">Mindset</div></button>
          <button class="card emo" data-view="emotions"><div class="ic">ğŸ©·</div><div class="tl">Emozioni</div><div class="st">Equilibrio</div></button>
          <button class="card fit" data-view="fitness"><div class="ic">ğŸ’ªğŸ¼</div><div class="tl">Fitness</div><div class="st">Alimentazione</div></button>
          <button class="card spi" data-view="spirituality"><div class="ic">ğŸ”®</div><div class="tl">SpiritualitÃ </div><div class="st">Crescita</div></button>
          <button class="card com" data-view="community"><div class="ic">ğŸ«‚</div><div class="tl">Community</div><div class="st">Connessioni</div></button>
          <button class="card pro" data-view="profile"><div class="ic">ğŸ«†</div><div class="tl">Profilo</div><div class="st">Il tuo universo</div></button>
        </section>
      </div>

      <!-- CARRIERA -->
      <section id="career" class="view" aria-label="Carriera">
        <div class="head"><button class="back" data-back>â†</button><div class="title">ğŸ§  Carriera & Mindset</div></div>
        <div class="ai">"Oggi Ã¨ il giorno perfetto per trasformare i tuoi sogni in realtÃ . Jindi crede in te!"</div>

        <!-- Planner 00:00 â†’ 23:30 a step 30' -->
        <div class="panel">
          <h3>ğŸ“… Daily planner (00:00 â†’ 23:30)</h3>
          <div class="tiny">Tocca un orario per aggiungere attivitÃ . Spunta âœ… quando hai completato.</div>
          <div id="planner-grid"></div>
          <div class="tiny">I dati restano sul dispositivo (localStorage).</div>
        </div>

        <!-- Calcolo rapido: solo Lordo -->
        <div class="panel">
          <h3>ğŸ’¶ Calcolo Rapido</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <input id="hours" class="in" inputmode="decimal" placeholder="Ore" />
            <input id="rate" class="in" inputmode="decimal" placeholder="â‚¬/ora" />
            <div class="row" style="grid-column:1/3"><span>Lordo</span><strong>â‚¬ <span id="gross">0.00</span></strong></div>
          </div>
        </div>

        <!-- Obiettivi -->
        <div class="panel">
          <h3>ğŸ¯ Obiettivi</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <textarea id="goals-short" class="in" rows="5" placeholder="Breve termine (1â€“3 mesi)"></textarea>
            <textarea id="goals-long" class="in" rows="5" placeholder="Lungo termine (6â€“12+ mesi)"></textarea>
          </div>
        </div>

        <!-- Podcast & Libri (vetrina) -->
        <div class="panel">
          <h3>ğŸ§ Podcast & ğŸ“š Libri</h3>
          <div class="row"><span>Mindset Sprint â€“ Audio corso</span><a class="in" href="https://buy.stripe.com/cNicN53Lp5WW46y6Y1d0Q03" target="_blank">Acquista</a></div>
          <div class="row"><span>Manuale: Focus Profondo</span><a class="in" href="https://buy.stripe.com/5kQeVd6XBCLj8W05TXd0Q04" target="_blank">Acquista</a></div>
        </div>
      </section>

      <!-- EMOZIONI -->
      <section id="emotions" class="view" aria-label="Emozioni">
        <div class="head"><button class="back" data-back>â†</button><div class="title">ğŸ©· Emozioni</div></div>
        <div class="ai">"Le tue emozioni sono valide. Navighiamo insieme questo mare interiore."</div>

        <div class="panel">
          <h3>ğŸ˜Š Tracker Umore</h3>
          <div class="row">
            <select id="mood-time" class="in" style="max-width:140px"></select>
            <div style="display:flex;gap:6px">
              <button class="in" style="width:auto" data-mood="ğŸ˜¢">ğŸ˜¢</button>
              <button class="in" style="width:auto" data-mood="ğŸ˜">ğŸ˜</button>
              <button class="in" style="width:auto" data-mood="ğŸ˜Š">ğŸ˜Š</button>
              <button class="in" style="width:auto" data-mood="ğŸ˜„">ğŸ˜„</button>
              <button class="in" style="width:auto" data-mood="ğŸ¤©">ğŸ¤©</button>
            </div>
          </div>
          <input id="intensity" type="range" min="1" max="10" value="7" style="width:100%">
          <p>Orario: <strong id="mood-time-val">00:00</strong> â€“ IntensitÃ : <strong><span id="intensity-val">7</span>/10</strong> â€“ Umore: <strong><span id="mood-val">ğŸ˜Š</span></strong></p>
          <div class="row"><input type="file" class="in" id="mood-file" multiple /></div>
          <div class="panel"><h4 style="margin:0 0 6px">ğŸ“ˆ Andamento</h4><svg id="mood-chart" width="100%" height="80"></svg><div class="tiny">Grafico giornaliero (oggi) â€“ media settimanale visibile tornando ogni giorno ğŸ˜Š</div></div>
          <div class="row"><button id="share-psych" class="in" style="width:auto">Condividi con psicologo (link protetto)</button><span class="tiny" id="share-link"></span></div>
        </div>
      </section>

      <!-- FITNESS -->
      <section id="fitness" class="view" aria-label="Fitness e Alimentazione">
        <div class="head"><button class="back" data-back>â†</button><div class="title">ğŸ’ªğŸ¼ Fitness & Alimentazione</div></div>
        <div class="ai">"Il corpo Ã¨ il tempio dellâ€™anima. Un passo alla volta!"</div>

        <div class="panel">
          <h3>ğŸ’§ Contatori Giornalieri</h3>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div class="panel" style="flex:1;min-width:120px">
              <div>ğŸ’§ Idratazione</div>
              <div style="font-size:24px;font-weight:800;margin:8px 0" id="water-count">0</div>
              <div><button data-counter="water" data-delta="-1">âˆ’</button><button data-counter="water" data-delta="1">+</button></div>
              <div class="tiny">bicchieri</div>
            </div>
            <div class="panel" style="flex:1;min-width:120px">
              <div>ğŸš­ Sigarette</div>
              <div style="font-size:24px;font-weight:800;margin:8px 0" id="cig-count">0</div>
              <div><button data-counter="cig" data-delta="-1">âˆ’</button><button data-counter="cig" data-delta="1">+</button></div>
              <div class="tiny">oggi</div>
            </div>
            <div class="panel" style="flex:1;min-width:120px">
              <div>ğŸ· Alcol</div>
              <div style="font-size:24px;font-weight:800;margin:8px 0" id="alcohol-count">0</div>
              <div><button data-counter="alcohol" data-delta="-1">âˆ’</button><button data-counter="alcohol" data-delta="1">+</button></div>
              <div class="tiny">unitÃ </div>
            </div>
          </div>
        </div>

        <!-- Dati fisici -->
        <div class="panel">
          <h3>ğŸ“ Dati personali</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input id="kg" class="in" inputmode="decimal" placeholder="Kg">
            <input id="arms" class="in" inputmode="decimal" placeholder="Braccia (cm)">
            <input id="chest" class="in" inputmode="decimal" placeholder="Petto (cm)">
            <input id="waist" class="in" inputmode="decimal" placeholder="Vita (cm)">
            <input id="hips" class="in" inputmode="decimal" placeholder="Fianchi (cm)">
            <input id="legs" class="in" inputmode="decimal" placeholder="Gambe (cm)">
          </div>
        </div>

        <!-- Nutrizione -->
        <div class="panel">
          <h3>ğŸ½ï¸ Nutrizione (kcal)</h3>
          <div class="tiny">Inserisci piatto e calorie; totale si aggiorna automaticamente.</div>
          <div id="meals">
            <!-- righe generate via JS: colazione, spuntino, pranzo, merenda, cena, spuntino -->
          </div>
          <div class="row"><span>Totale oggi</span><strong><span id="kcal-total">0</span> kcal</strong></div>
        </div>

        <!-- Lista spesa & Ricette AI -->
        <div class="panel">
          <h3>ğŸ§¾ Spesa & ricette (AI)</h3>
          <input id="ingredients-input" class="in" placeholder="Scrivi ingredienti o incolla la lista (es. uova, cipolle)"/>
          <div class="row">
            <input type="file" id="groceries-photo" class="in" style="max-width:180px">
            <button id="recipes-btn" class="in" style="width:auto">Suggerisci ricette (AI)</button>
          </div>
          <pre id="recipes-out" class="in" style="min-height:80px;white-space:pre-wrap"></pre>
          <div class="tiny">Lâ€™OCR delle foto non Ã¨ attivo qui: lâ€™AI userÃ  solo il testo degli ingredienti.</div>
        </div>

        <!-- Workout AI -->
        <div class="panel">
          <h3>ğŸ‹ï¸â€â™€ï¸ Workout (AI)</h3>
          <div class="row">
            <input id="workout-goal" class="in" placeholder="Obiettivo (es. Forza, Dimagrimento)">
            <input id="workout-days" class="in" inputmode="numeric" placeholder="Giorni/sett. (es. 3)" style="max-width:130px">
            <button id="workout-btn" class="in" style="width:auto">Genera piano</button>
          </div>
          <pre id="workout-out" class="in" style="min-height:80px;white-space:pre-wrap"></pre>
        </div>
      </section>

      <!-- SPIRITUALITÃ€ -->
      <section id="spirituality" class="view" aria-label="SpiritualitÃ ">
        <div class="head"><button class="back" data-back>â†</button><div class="title">ğŸ”® SpiritualitÃ </div></div>
        <div class="ai" style="background:linear-gradient(135deg,var(--p3),var(--p1))">"Le stelle ti sussurrano: oggi Ã¨ giorno di trasformazione."</div>
        <div class="panel" style="text-align:center">
          <h3>ğŸ§˜â€â™€ï¸ Meditazione Guidata</h3>
          <div id="med-timer" style="font-size:32px;font-weight:800;color:var(--p1);margin:8px 0">05:00</div>
          <button id="med-toggle" class="in" style="cursor:pointer;width:auto">â–¶ï¸ Avvia/Metti in pausa</button>
        </div>

        <div class="panel">
          <h3>ğŸª Tema natale (AI)</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px">
            <input id="astro-date" class="in" type="date" />
            <input id="astro-time" class="in" type="time" />
            <input id="astro-place" class="in" placeholder="Luogo (es. Broni, PV)" style="grid-column:1/3" />
          </div>
          <button id="astro-btn" class="in" style="width:auto">Analizza influenza su azioni & umore</button>
          <pre id="astro-out" class="in" style="min-height:80px;white-space:pre-wrap;margin-top:8px">â€”</pre>
          <div class="tiny">Per un calcolo astronomico preciso servono effemeridi; qui lâ€™AI fa una lettura personalizzata.</div>
        </div>
      </section>

      <!-- COMMUNITY -->
      <section id="community" class="view" aria-label="Community">
        <div class="head"><button class="back" data-back>â†</button><div class="title">ğŸ«‚ Community</div></div>
        <div class="ai">"Insieme siamo piÃ¹ forti!"</div>

        <div class="panel">
          <h3>âœ¨ Condividi il tuo momento</h3>
          <textarea rows="3" class="in" id="post-text" placeholder="Cosa stai pensando oggi?"></textarea>
          <div class="row">
            <span>Allega ğŸ“· ğŸ¯ ğŸ’¡</span>
            <button id="post-btn" class="in" style="width:auto;cursor:pointer">Pubblica</button>
          </div>
        </div>

        <div class="panel" id="feed">
          <h3>ğŸ“° Feed</h3>
          <div class="row"><span>@MindfulSara</span><span>â€œPrima meditazione di 20â€™ fatta! ğŸ§˜â€â™€ï¸â€</span></div>
          <div class="row"><span>@FitnessMarco</span><span>â€œ10.000 passi al giorno âœ…â€</span></div>
        </div>
      </section>

      <!-- PROFILO -->
      <section id="profile" class="view" aria-label="Profilo">
        <div class="head"><button class="back" data-back>â†</button><div class="title">ğŸ«† Profilo</div></div>
        <div class="ai">"Il tuo profilo Ã¨ la mappa del tuo universo."</div>

        <div class="panel">
          <h3>ğŸ‘¤ Info</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <input class="in" value="Alessandro" placeholder="Nome">
            <input class="in" value="Rossi" placeholder="Cognome">
            <input class="in" value="alex@mindflow.app" placeholder="Email">
            <input class="in" type="date" value="1995-03-15">
          </div>
        </div>

        <div class="panel">
          <h3>ğŸ”” Notifiche</h3>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox" checked> ğŸ§  Carriera</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox"> ğŸ©· Emozioni</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox" checked> ğŸ’ªğŸ¼ Fitness</label>
          <label style="display:flex;align-items:center;gap:8px;margin:6px 0"><input type="checkbox" checked> ğŸ”® SpiritualitÃ </label>
        </div>

        <div class="panel">
          <h3>ğŸ’ Piano</h3>
          <div class="row"><span>Piano attivo:</span><strong>Fiori</strong></div>
          <div class="row"><span>Rinnovo:</span><strong>15/09/2024</strong></div>
        </div>

        <div class="panel">
          <h3>ğŸš€ Upgrade Piano</h3>
          <p class="tiny" style="margin:0 0 8px">Sblocca contenuti premium, piani personalizzati e prioritÃ  con Jindi.</p>
          <div style="display:grid;grid-template-columns:1fr;gap:8px">
            <a class="in" href="https://buy.stripe.com/cNicN53Lp5WW46y6Y1d0Q03" target="_blank" rel="noreferrer">ğŸŒ± Boccioli â€“ â‚¬7,99/mese</a>
            <a class="in" href="https://buy.stripe.com/5kQeVd6XBCLj8W05TXd0Q04" target="_blank" rel="noreferrer">ğŸŒ¸ Fiori â€“ â‚¬12,99/mese</a>
            <a class="in" href="https://buy.stripe.com/00w7sL3Lpclj3Cucild0Q05" target="_blank" rel="noreferrer">ğŸ’ Premium â€“ â‚¬149,99/mese</a>
          </div>
          <small class="tiny">Il pagamento si apre in una nuova scheda su Stripe.</small>
        </div>
      </section>
    </main>

    <nav class="bottom" aria-label="Navigazione">
      <button class="homebtn" id="go-home" aria-label="Home">ğŸ </button>
      <button class="sys" id="open-system" aria-haspopup="dialog">Sistema âš™ï¸</button>
    </nav>
  </div>

  <!-- Bolla Jindi -->
  <button class="jindi" id="jindi" aria-controls="chat" aria-expanded="false">ğŸ‘‹</button>

  <!-- Chat -->
  <section class="chat" id="chat" aria-live="polite" aria-label="Chat con Jindi">
    <div class="chathead">
      <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center">ğŸ‘‹</div>
      <div><strong>Jindi AI</strong><div style="font-size:10px;opacity:.7">Il tuo assistente</div></div>
      <button id="close-chat" style="margin-left:auto;background:none;border:0;color:#ccc;font-size:18px">Ã—</button>
    </div>
    <div class="msgs" id="msgs"><div class="msg ai">Ciao! Come posso aiutarti oggi? ğŸŒŸ</div></div>
    <input id="chat-in" class="in" placeholder="Scrivi a Jindiâ€¦" />
  </section>

  <script>
    // helpers
    const $ = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
    const LS = {
      get:(k,def)=>{try{return JSON.parse(localStorage.getItem(k))??def}catch{return def}},
      set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
    };

    // router
    const views = ["home","career","emotions","fitness","spirituality","community","profile"];
    function show(v){ views.forEach(x=>$("#"+x).classList.toggle("active", x===v)); location.hash="#"+v; }
    window.addEventListener("hashchange", ()=>{ const v=(location.hash||"#home").slice(1); show(views.includes(v)?v:"home"); });

    // nav
    $$("#home .card").forEach(b=>b.addEventListener("click", ()=>show(b.dataset.view)));
    $$("[data-back]").forEach(b=>b.addEventListener("click", ()=>history.back()));
    $("#go-home").addEventListener("click", ()=>show("home"));
    $("#open-system").addEventListener("click", ()=>alert("Impostazioni, Backup, Supporto, Info App"));

    /* ===== Planner 00:00â†’23:30, 30' ==== */
    (function buildPlanner(){
      const wrap = $("#planner-grid"); if(!wrap) return;
      wrap.style.display="grid"; wrap.style.gridTemplateColumns="80px 1fr"; wrap.style.gap="6px";
      const key="planner-"+new Date().toISOString().slice(0,10);
      const data=LS.get(key,{});
      function slotLabel(i){const h=Math.floor(i/2), m=i%2?30:0; return String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");}
      for(let i=0;i<48;i++){
        const time=slotLabel(i);
        const lab=document.createElement("div"); lab.className="tiny"; lab.textContent=time;
        const row=document.createElement("div"); row.className="row"; row.style.gap="6px";
        const chk=document.createElement("input"); chk.type="checkbox"; chk.checked=!!data[time]?.done;
        const inp=document.createElement("input"); inp.className="in"; inp.placeholder="Aggiungi attivitÃ â€¦"; inp.value=data[time]?.txt||"";
        chk.addEventListener("change", ()=>{data[time]={txt:inp.value,done:chk.checked}; LS.set(key,data);});
        inp.addEventListener("change", ()=>{data[time]={txt:inp.value,done:chk.checked}; LS.set(key,data);});
        row.append(chk,inp); wrap.append(lab,row);
      }
    })();

    /* ===== Calcolo Lordo ===== */
    const hours=$("#hours"), rate=$("#rate"), gross=$("#gross");
    function calc(){ const h=parseFloat(hours?.value||0)||0; const r=parseFloat(rate?.value||0)||0; const g=h*r; gross && (gross.textContent=g.toFixed(2)); }
    hours?.addEventListener("input", calc); rate?.addEventListener("input", calc);

    /* ===== Obiettivi (localStorage) ===== */
    (function goals(){
      const s=$("#goals-short"), l=$("#goals-long"); if(!s||!l) return;
      const K="goals"; const mem=LS.get(K,{short:"",long:""}); s.value=mem.short; l.value=mem.long;
      const save=()=>LS.set(K,{short:s.value,long:l.value}); s.addEventListener("input",save); l.addEventListener("input",save);
    })();

    /* ===== Emotions tracker ===== */
    (function moods(){
      const moodVal=$("#mood-val"), intensity=$("#intensity"), intensityVal=$("#intensity-val");
      const moodTime=$("#mood-time"), moodTimeVal=$("#mood-time-val"), file=$("#mood-file"), chart=$("#mood-chart");
      const dayKey="moods-"+new Date().toISOString().slice(0,10);
      // time options 00:00â†’23:30
      if(moodTime){ for(let i=0;i<48;i++){ const h=String(Math.floor(i/2)).padStart(2,"0"); const m=i%2?"30":"00"; const o=document.createElement("option"); o.value=h+":"+m; o.textContent=o.value; moodTime.append(o);} moodTime.value="00:00"; moodTimeVal.textContent=moodTime.value; moodTime.onchange=()=>moodTimeVal.textContent=moodTime.value; }
      $$("[data-mood]").forEach(btn=>btn.addEventListener("click", ()=>{ if(moodVal) moodVal.textContent=btn.dataset.mood; }));
      intensity?.addEventListener("input", e=>{ intensityVal.textContent=e.target.value; savePoint(); draw(); });
      function savePoint(){
        const data=LS.get(dayKey,[]);
        const t=moodTime?.value||"00:00", mood=moodVal?.textContent||"ğŸ˜Š", val=Number(intensity?.value||7);
        const idx=data.findIndex(x=>x.t===t); const rec={t:t,m:mood,v:val};
        if(idx>-1) data[idx]=rec; else data.push(rec);
        LS.set(dayKey,data);
      }
      function draw(){
        if(!chart) return;
        const data=LS.get(dayKey,[]).sort((a,b)=>a.t.localeCompare(b.t));
        chart.innerHTML=""; const w=chart.clientWidth||300, h=80, p=6;
        const max=10; const x=(i)=>p+(w-2*p)*(i/Math.max(1,data.length-1)); const y=(v)=>h-p-(v/max)*(h-2*p);
        let path=""; data.forEach((d,i)=>{ path+= (i? " L ":" M ")+x(i)+","+y(d.v); });
        const grid=document.createElementNS("http://www.w3.org/2000/svg","path"); grid.setAttribute("d",`M ${p},${y(5)} L ${w-p},${y(5)}`); grid.setAttribute("stroke","#333");
        const line=document.createElementNS("http://www.w3.org/2000/svg","path"); line.setAttribute("d",path||""); line.setAttribute("fill","none"); line.setAttribute("stroke","#FFB6C1"); line.setAttribute("stroke-width","2");
        chart.append(grid,line);
      }
      file?.addEventListener("change", ()=>alert("File aggiunti (salvati localmente dal browser)."));
      draw();
      // salvataggio al click sui volti
      $$("[data-mood]").forEach(btn=>btn.addEventListener("click", ()=>{ savePoint(); draw(); }));
    })();

    // Link condivisibile (password semplice lato client)
    $("#share-psych")?.addEventListener("click", ()=>{
      const pwd=prompt("Imposta una password per lo psicologo:");
      if(!pwd) return;
      const token=btoa(JSON.stringify({d:new Date().toISOString().slice(0,10),p:pwd}));
      const url=location.origin+location.pathname+"#share="+token;
      $("#share-link").textContent=url;
      alert("Invia questo link allo psicologo. Gli verrÃ  chiesta la password.");
    });
    // Se arrivo con #share=... chiedo password e mostro i dati umore del giorno
    (function checkShare(){
      const m=location.hash.match(/share=([^&]+)/); if(!m) return;
      try{
        const obj=JSON.parse(atob(m[1])); const pass=prompt("Password per accedere:");
        if(pass!==obj.p) { alert("Password errata"); location.hash="#home"; return; }
        show("emotions");
        const dayKey="moods-"+obj.d; const data=LS.get(dayKey,[]);
        alert("Report umore di "+obj.d+":\n"+data.map(x=>x.t+" "+x.m+" intensitÃ  "+x.v).join("\n"));
      }catch{}
    })();

    /* ===== Contatori ===== */
    (function counters(){
      const ids=["water","cig","alcohol"]; const K="counts-"+new Date().toISOString().slice(0,10);
      const st=LS.get(K,{water:0,cig:0,alcohol:0});
      ids.forEach(id=>{ const el=$("#"+id+"-count"); if(el) el.textContent=st[id]||0; });
      $$("[data-counter]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const n=btn.dataset.counter; const d=parseInt(btn.dataset.delta,10);
          st[n]=Math.max(0,(st[n]||0)+d); $("#"+n+"-count").textContent=st[n]; LS.set(K,st);
        });
      });
    })();

    /* ===== Nutrizione (kcal) ===== */
    (function nutrition(){
      const meals=$("#meals"); if(!meals) return;
      const names=["Colazione","Spuntino","Pranzo","Merenda","Cena","Spuntino sera"];
      meals.innerHTML=names.map((n,i)=>`
        <div class="row">
          <input class="in" id="meal-name-${i}" placeholder="${n}">
          <input class="in" id="meal-kcal-${i}" inputmode="numeric" placeholder="kcal" style="max-width:120px">
        </div>
      `).join("");
      const total=$("#kcal-total"); const K="kcal-"+new Date().toISOString().slice(0,10);
      function load(){ const v=LS.get(K,Array(6).fill({n:"",k:0})); v.forEach((m,i)=>{ $("#meal-name-"+i).value=m.n; $("#meal-kcal-"+i).value=m.k; }); recalc(); }
      function save(){ const v=[...Array(6).keys()].map(i=>({n:$("#meal-name-"+i).value,k:Number($("#meal-kcal-"+i).value||0)})); LS.set(K,v); recalc(); }
      function recalc(){ const v=LS.get(K,Array(6).fill({n:"",k:0})); const sum=v.reduce((s,m)=>s+Number(m.k||0),0); total.textContent=sum; }
      meals.addEventListener("input", save); load();
    })();

    /* ===== AI ENDPOINTS ===== */
    async function callAI(url, payload, outEl){
      try{
        outEl && (outEl.textContent="â³ Sto pensandoâ€¦");
        const r = await fetch(url,{ method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error(await r.text());
        const { text, reply } = await r.json();
        outEl && (outEl.textContent = text || reply || "â€”");
      }catch(e){ outEl && (outEl.textContent="Ops, non riesco ora ğŸ™"); console.error(e); }
    }

    // Recipes
    $("#recipes-btn")?.addEventListener("click", ()=>{
      callAI("/api/recipes",{ ingredients: $("#ingredients-input")?.value || "" }, $("#recipes-out"));
    });

    // Workout
    $("#workout-btn")?.addEventListener("click", ()=>{
      callAI("/api/workout",{ goal: $("#workout-goal")?.value || "", days: $("#workout-days")?.value || "3" }, $("#workout-out"));
    });

    // Astro
    $("#astro-btn")?.addEventListener("click", ()=>{
      callAI("/api/astro",{ date: $("#astro-date")?.value, time: $("#astro-time")?.value, place: $("#astro-place")?.value }, $("#astro-out"));
    });

    /* ===== Meditazione ===== */
    const medBtn=$("#med-toggle"), medTimer=$("#med-timer"); let secs=5*60, iv=null;
    function rend(){const m=Math.floor(secs/60), s=secs%60; medTimer.textContent=String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");}
    function start(){ if(iv) return; iv=setInterval(()=>{ if(secs>0){secs--;rend();}else{stop();secs=5*60;rend();alert("Meditazione completata âœ¨");}},1000); }
    function stop(){ clearInterval(iv); iv=null; }
    medBtn?.addEventListener("click", ()=> iv?stop():start()); rend();

    /* ===== Community ===== */
    $("#post-btn")?.addEventListener("click", ()=>{
      const t=$("#post-text").value.trim(); if(!t) return;
      const row=document.createElement("div"); row.className="row"; row.innerHTML=`<span>@Tu</span><span>${t}</span>`;
      $("#feed").appendChild(row); $("#post-text").value="";
    });

    /* ===== Chat Jindi ===== */
    const bubble=$("#jindi"), chat=$("#chat"), closeChat=$("#close-chat"), input=$("#chat-in"), msgs=$("#msgs");
    function toggleChat(open){ const isOpen=open??!chat.classList.contains("active"); chat.classList.toggle("active", isOpen); bubble.setAttribute("aria-expanded", String(isOpen)); if(isOpen) input.focus(); }
    bubble.addEventListener("click", ()=>toggleChat()); closeChat.addEventListener("click", ()=>toggleChat(false));
    function addMsg(text, who="ai"){ const d=document.createElement("div"); d.className="msg "+who; d.textContent=text; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; }
    async function generateAIResponse(userMessage){
      try{
        const r = await fetch("/api/chat", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ message: userMessage }) });
        if(!r.ok) throw new Error(await r.text());
        const data = await r.json();
        return data.reply || "Sto riflettendoâ€¦ âœ¨";
      }catch(e){ console.error(e); return "Ops, non riesco ora. Riprova tra poco ğŸ™"; }
    }
    input.addEventListener("keydown", async e=>{
      if(e.key==="Enter"){
        const text=input.value.trim(); if(!text) return;
        addMsg(text,"me"); input.value="";
        const reply = await generateAIResponse(text);
        addMsg(reply,"ai");
      }
    });

    // start
    show((location.hash||"#home").slice(1));
  </script>
</body>
</html>
