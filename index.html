<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>MINDflow</title>
  <link rel="stylesheet" href="/styles/globals.css">
  <link rel="apple-touch-icon" href="/public/icons/apple-touch-icon.png">
</head>
<body>
  <header class="hero">
    <h1>MINDflow</h1>
    <p>Il tuo viaggio verso la consapevolezza</p>
  </header>

  <!-- GRID HOME (immutata) -->
  <main id="home" class="grid">
    <a class="tile navy" data-route="career">
      <div class="icon">🧠</div>
      <div class="t1">Carriera</div><div class="t2">Mindset</div>
    </a>
    <a class="tile plum" data-route="emotions">
      <div class="icon">💖</div>
      <div class="t1">Emozioni</div><div class="t2">Equilibrio</div>
    </a>
    <a class="tile earth" data-route="fitness">
      <div class="icon">💪</div>
      <div class="t1">Fitness</div><div class="t2">Salute</div>
    </a>
    <a class="tile green" data-route="spiritual">
      <div class="icon">🔮</div>
      <div class="t1">Spiritualità</div><div class="t2">Crescita</div>
    </a>
    <a class="tile sand" data-route="community">
      <div class="icon">🫂</div>
      <div class="t1">Community</div><div class="t2">Connessioni</div>
    </a>
    <a class="tile wine" data-route="profile">
      <div class="icon">🌀</div>
      <div class="t1">Profilo</div><div class="t2">Piani</div>
    </a>
  </main>

  <!-- FAB + Pannello Sistema -->
  <button id="fab-home" class="fab" data-route="home">🏠</button>
  <div class="system-btn" id="open-system">Sistema ⚙️</div>

  <dialog id="system-modal">
    <form method="dialog" class="panel">
      <div class="head"><button class="back">←</button><div class="title">⚙️ Sistema</div></div>

      <section class="section">
        <h3>🔔 Notifiche</h3>
        <div class="row">
          <label class="switch">
            <input id="notif-toggle" type="checkbox">
            <span></span>
          </label>
          <div>Promemoria (meditazione, acqua, workout, journaling)</div>
        </div>
        <div class="small">Le notifiche push richiedono consenso del browser. Su iOS Safari potrebbero non apparire: useremo email/Push API quando abilitate.</div>
      </section>

      <section class="section">
        <h3>🔐 Privacy</h3>
        <label class="row" style="align-items:flex-start;gap:10px">
          <input id="privacy-accept" type="checkbox" style="margin-top:4px">
          <span>Ho letto e accetto la <a href="/public/privacy.md" target="_blank">Privacy Policy</a> e i Termini.</span>
        </label>
        <div class="small">Questo flag abilita l’uso di funzionalità cloud (Supabase) quando le attiverai.</div>
      </section>

      <section class="section">
        <h3>🧰 Collegamenti (dev)</h3>
        <div class="kv"><span>Stripe status:</span><code id="stripe-status">test</code></div>
        <div class="kv"><span>Supabase URL:</span><code id="sb-url"></code></div>
        <div class="kv"><span>Site URL:</span><code id="site-url"></code></div>
        <button class="btn" id="btn-test-checkout">Prova checkout (Boccioli)</button>
      </section>

      <menu class="row" style="justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" value="cancel">Chiudi</button>
      </menu>
    </form>
  </dialog>

  <!-- Router Target -->
  <div id="view-host"></div>

  <script>
  // ---- Router super leggero (carica /views/<page>.html nel #view-host) ----
  const host = document.getElementById('view-host');
  const home = document.getElementById('home');
  function go(route){
    if(route==='home'){ host.innerHTML=''; home.style.display='grid'; history.pushState({route:'home'}, '', '/'); return; }
    fetch(`/views/${route}.html`).then(r=>r.text()).then(html=>{
      home.style.display='none';
      host.innerHTML = html;
      history.pushState({route}, '', `/#/${route}`);
      window.scrollTo(0,0);
    }).catch(()=>alert('Vista non trovata: '+route));
  }
  document.querySelectorAll('[data-route]').forEach(el=>el.addEventListener('click',()=>go(el.dataset.route)));
  window.addEventListener('popstate', (e)=> go((e.state&&e.state.route)||'home'));
  document.getElementById('fab-home').onclick=()=>go('home');

  // ---- Sistema dialog ----
  const dlg = document.getElementById('system-modal');
  document.getElementById('open-system').onclick = ()=> dlg.showModal();
  dlg.querySelector('.back').onclick = ()=> dlg.close();

  const siteUrl = (typeof window !== 'undefined') ? (window.__SITE_URL__ || window.location.origin) : '';
  document.getElementById('site-url').textContent = siteUrl;
  document.getElementById('sb-url').textContent = (window.__SUPABASE_URL__ || '—');
  document.getElementById('stripe-status').textContent = 'TEST';

  // toggles persistiti
  const LS = (k,v)=>{
    const key='mf_sys_'+k;
    if(v===undefined){ try{return JSON.parse(localStorage.getItem(key));}catch{return null;} }
    localStorage.setItem(key, JSON.stringify(v));
  };
  const notifToggle = document.getElementById('notif-toggle');
  notifToggle.checked = !!LS('notif');
  notifToggle.onchange = ()=> LS('notif', notifToggle.checked);

  const privacy = document.getElementById('privacy-accept');
  privacy.checked = !!LS('privacy');
  privacy.onchange = ()=> LS('privacy', privacy.checked);

  // test checkout (Boccioli)
  document.getElementById('btn-test-checkout').onclick = async ()=>{
    const r = await fetch('/api/checkout', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ plan: 'buds', success_url: location.origin+'/#/profile?ok=1', cancel_url: location.href })
    });
    const {url, error} = await r.json();
    if(error){ alert(error); return; }
    location.href = url;
  };

  // atterraggio diretto via hash
  if(location.hash.startsWith('#/')) go(location.hash.replace('#/',''));
  </script>
</body>
</html>
