<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>MINDflow ‚Äì App</title>
<style>
:root{
  --bg:#000; --text:#fff; --dim:#cfcfd2;
  --panel:rgba(255,255,255,.05); --panel2:rgba(255,255,255,.1); --bd:rgba(255,255,255,.12);
  --p1:#FFB6C1; --p2:#FFDAB9; --p3:#9370DB;
  --shadow:0 6px 24px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:#000;color:#fff;font:14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;overflow:hidden}
.app{height:100%;max-width:390px;margin:0 auto;display:flex;flex-direction:column;border:1px solid #222;border-radius:25px;background:rgba(0,0,0,.95);backdrop-filter:blur(10px);overflow:hidden}
.topbar{padding:18px 16px 6px;text-align:center;border-bottom:1px solid #222;background:linear-gradient(135deg,#000,#1a1a1a)}
.logo{font-size:28px;font-weight:800;background:linear-gradient(45deg,var(--p1),var(--p2),var(--p1));-webkit-background-clip:text;background-clip:text;-webkit-text-fill-color:transparent}
.tag{font-size:12px;color:#9aa;font-style:italic;margin-top:4px}
main{flex:1;overflow:auto;padding:18px 16px 110px}

/* HOME centrata 2 colonne */
.home-wrap{height:100%;display:grid;place-items:center}
.home{
  display:grid; grid-template-columns:repeat(2,150px); grid-auto-rows:150px; gap:16px;
  place-content:center; place-items:center;
}
.card{
  display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px;
  width:150px; height:150px; border-radius:16px; border:1px solid var(--bd);
  color:#fff; text-align:center; cursor:pointer; transition:transform .18s ease; box-shadow:var(--shadow)
}
.card:focus-visible{outline:2px solid var(--p1); outline-offset:2px}
.ic{font-size:28px}.tl{font-weight:700}.st{font-size:11px;opacity:.8}
.career{background:linear-gradient(135deg,#1a1a2e,#16213e)}
.emo{background:linear-gradient(135deg,#2d1b2e,#3e2640)}
.fit{background:linear-gradient(135deg,#2e1f1a,#3e2a1b)}
.spi{background:linear-gradient(135deg,#1a2e1f,#1b3e26)}
.com{background:linear-gradient(135deg,#2e2a1a,#3e361b)}
.pro{background:linear-gradient(135deg,#2e1a2a,#3e1b2f)}

.view{display:none;animation:fade .24s ease}
.view.active{display:block}
.head{display:flex;align-items:center;gap:8px;margin-bottom:14px;padding:12px;background:var(--panel);border:1px solid var(--bd);border-radius:12px}
.back{appearance:none;border:0;background:none;color:#FFB6C1;font-size:18px;cursor:pointer}
.title{font-size:18px;font-weight:800}
.ai{background:linear-gradient(135deg,var(--p1),var(--p2));color:#000;padding:12px;border-radius:12px;margin-bottom:12px;position:relative;font-style:italic}
.ai:before{content:"ü§ñ";position:absolute;right:10px;top:-6px}
.panel{background:var(--panel);border:1px solid var(--bd);border-radius:12px;padding:12px;margin-bottom:12px}
.row{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;background:var(--panel2);border-radius:8px;margin-top:8px}
.in{width:100%;padding:8px;border-radius:8px;border:1px solid #333;color:#fff;background:rgba(255,255,255,.08)}
.small{font-size:12px;opacity:.8}

/* bottom bar */
.bottom{position:fixed;left:0;right:0;bottom:0;height:84px;background:linear-gradient(135deg,#111,#000);
  border-top:1px solid #222;display:flex;justify-content:center;align-items:center;padding-bottom:calc(env(safe-area-inset-bottom));z-index:10}
.homebtn{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;background:linear-gradient(135deg,var(--p1),var(--p2));border:0;cursor:pointer}
.sys{position:absolute;right:20px;font-size:12px;color:#FFB6C1;background:rgba(255,182,193,.1);border:1px solid rgba(255,182,193,.35);padding:8px 12px;border-radius:12px;cursor:pointer}

/* chat */
.jindi{position:fixed;right:18px;bottom:104px;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center;box-shadow:0 4px 18px rgba(255,182,193,.35);cursor:pointer;z-index:20;animation:wave 2s infinite}
.chat{position:fixed;right:18px;bottom:174px;width:300px;height:420px;display:none;z-index:25;background:rgba(0,0,0,.95);border:1px solid var(--p1);border-radius:15px;padding:12px;backdrop-filter:blur(10px)}
.chat.active{display:block;animation:up .22s ease}
.chathead{display:flex;align-items:center;gap:8px;padding-bottom:8px;border-bottom:1px solid #333}
.msgs{height:300px;overflow:auto;margin:10px 0}
.msg{max-width:80%;padding:8px 12px;border-radius:12px;margin-bottom:8px}
.msg.ai{background:linear-gradient(135deg,var(--p1),var(--p2));color:#000}
.msg.me{background:var(--panel2)}

@media (prefers-reduced-motion:reduce){*{animation:none!important;transition:none!important}}
@keyframes wave{0%,100%{transform:rotate(0)}25%{transform:rotate(12deg)}75%{transform:rotate(-12deg)}}
@keyframes up{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
@keyframes fade{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

/* mini utilit√† */
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
hr{border:0;border-top:1px solid #333;margin:10px 0}
.btn{background:linear-gradient(135deg,var(--p1),var(--p2));border:0;padding:8px 10px;border-radius:10px;cursor:pointer;color:#000;font-weight:700}
.badge{font-size:11px;padding:2px 8px;border:1px solid #444;border-radius:999px;opacity:.85}
</style>
</head>
<body>
<div class="app">
  <div class="topbar">
    <div class="logo">MINDflow</div>
    <div class="tag">Il tuo viaggio verso la consapevolezza</div>
  </div>

  <main id="main">
    <!-- HOME -->
    <div class="home-wrap view active" id="home" aria-label="Home">
      <section class="home">
        <button class="card career" data-view="career"><div class="ic">üß†</div><div class="tl">Carriera</div><div class="st">Mindset</div></button>
        <button class="card emo" data-view="emotions"><div class="ic">ü©∑</div><div class="tl">Emozioni</div><div class="st">Equilibrio</div></button>
        <button class="card fit" data-view="fitness"><div class="ic">üí™üèº</div><div class="tl">Fitness</div><div class="st">Salute</div></button>
        <button class="card spi" data-view="spirituality"><div class="ic">üîÆ</div><div class="tl">Spiritualit√†</div><div class="st">Crescita</div></button>
        <button class="card com" data-view="community"><div class="ic">ü´Ç</div><div class="tl">Community</div><div class="st">Connessioni</div></button>
        <button class="card pro" data-view="profile"><div class="ic">ü´Ü</div><div class="tl">Profilo</div><div class="st">Piani</div></button>
      </section>
    </div>

    <!-- CARRIERA -->
    <section id="career" class="view" aria-label="Carriera">
      <div class="head"><button class="back" data-back>‚Üê</button><div class="title">üß† Carriera & Mindset</div></div>
      <div class="ai">"Oggi √® il giorno perfetto per trasformare i tuoi sogni in realt√†. Jindi crede in te!"</div>

      <!-- Priorit√† + obiettivi -->
      <div class="panel">
        <h3>‚ö†Ô∏è Priorit√† del giorno (max 3)</h3>
        <div id="prio-list"></div>
        <div class="grid2" style="margin-top:8px">
          <input id="prio-text" class="in" placeholder="Aggiungi priorit√†‚Ä¶" />
          <button id="prio-add" class="btn">+ Aggiungi</button>
        </div>
        <hr />
        <div class="grid2">
          <div>
            <h4>ü•á Obiettivo principale</h4>
            <input id="goal-main" class="in" placeholder="Cosa conta di pi√π oggi?">
          </div>
          <div>
            <h4>ü•à Mini obiettivi</h4>
            <input id="goal-mini" class="in" placeholder="Scrivi mini obiettivi separati da ;">
          </div>
        </div>
      </div>

      <!-- Planner 00:00-24:00  -->
      <div class="panel">
        <h3>üìÖ Daily Planner (30‚Äô)</h3>
        <div class="small">Da mezzanotte a mezzanotte. Tocca il testo per scrivere, spunta ‚úÖ per completare.</div>
        <div id="planner"></div>
      </div>

      <!-- Note / memo / meeting -->
      <div class="panel">
        <h3>üóíÔ∏è Note rapide & memo</h3>
        <textarea id="notes" rows="3" class="in" placeholder="Scrivi una nota veloce‚Ä¶"></textarea>
        <div class="grid2" style="margin-top:8px">
          <div>
            <h4>üíº Appuntamenti/Meeting</h4>
            <input id="meet" class="in" placeholder="Es. 15:00 call team‚Ä¶">
          </div>
          <div>
            <h4>üß© Sfida personale</h4>
            <input id="challenge" class="in" placeholder='Es. "zero social per 1h"'>
          </div>
        </div>
        <div style="margin-top:8px">
          <h4>üì∑ Cosa ti ha colpito oggi?</h4>
          <input id="wow-file" class="in" type="file" multiple>
        </div>
      </div>

      <!-- Bilancio -->
      <div class="panel">
        <h3>üí∞ Bilancio giornaliero</h3>
        <div class="grid3">
          <input id="cash-desc" class="in" placeholder="Descrizione">
          <input id="cash-in" class="in" inputmode="decimal" placeholder="Entrata ‚Ç¨">
          <input id="cash-out" class="in" inputmode="decimal" placeholder="Uscita ‚Ç¨">
        </div>
        <button id="cash-add" class="btn" style="margin-top:8px;width:100%">+ Registra</button>
        <div id="cash-list" style="margin-top:8px"></div>
        <div class="row"><span>Totale Entrate</span><strong>‚Ç¨ <span id="cash-in-tot">0.00</span></strong></div>
        <div class="row"><span>Totale Uscite</span><strong>‚Ç¨ <span id="cash-out-tot">0.00</span></strong></div>
      </div>

      <!-- Liste varie -->
      <div class="panel">
        <h3>üóÇÔ∏è Liste veloci</h3>
        <div class="grid3">
          <input id="todo-shop" class="in" placeholder="üõçÔ∏è Cose da comprare‚Ä¶">
          <input id="todo-home" class="in" placeholder="üßΩ Faccende domestiche‚Ä¶">
          <input id="todo-comm" class="in" placeholder="üì≤ Email / chiamate‚Ä¶">
        </div>
        <div class="grid2" style="margin-top:8px">
          <input id="todo-deadline" class="in" placeholder="‚è∞ Scadenze importanti‚Ä¶">
          <button id="todo-add" class="btn">+ Salva</button>
        </div>
        <div id="todo-lists" class="small" style="margin-top:8px"></div>
      </div>

      <!-- Calcolo rapido -->
      <div class="panel">
        <h3>üí∂ Calcolo Rapido</h3>
        <div class="grid2">
          <input id="hours" class="in" inputmode="decimal" placeholder="Ore" />
          <input id="rate" class="in" inputmode="decimal" placeholder="‚Ç¨/ora" />
        </div>
        <div class="row"><span>Lordo</span><strong>‚Ç¨ <span id="gross">0.00</span></strong></div>
      </div>
    </section>

    <!-- EMOZIONI -->
    <section id="emotions" class="view" aria-label="Emozioni">
      <div class="head"><button class="back" data-back>‚Üê</button><div class="title">ü©∑ Emozioni</div></div>
      <div class="ai">"Le tue emozioni sono valide. Navighiamo insieme questo mare interiore."</div>

      <div class="panel">
        <h3>üòä Tracker Umore (con orario)</h3>
        <div class="grid3">
          <input id="mood-time" class="in" type="time" value="08:00">
          <select id="mood-emo" class="in">
            <option>üò¢</option><option>üòê</option><option selected>üòä</option><option>üòÑ</option><option>ü§©</option>
          </select>
          <input id="mood-int" type="range" min="1" max="10" value="7" />
        </div>
        <div class="grid3" style="margin-top:8px">
          <input id="mood-trigger" class="in" placeholder="‚ÅâÔ∏è Trigger emotivo">
          <input id="mood-selfcare" class="in" placeholder="‚ú® Self-care del giorno">
          <input id="mood-file" class="in" type="file" multiple>
        </div>
        <button id="mood-add" class="btn" style="margin-top:8px;width:100%">+ Registra umore</button>
        <div id="mood-list" style="margin-top:8px"></div>
        <canvas id="mood-chart" width="340" height="120" style="margin-top:8px;background:rgba(255,255,255,.04);border:1px solid #333;border-radius:10px"></canvas>
        <div class="small">Grafico giornaliero/settimanale (toggle): <span class="badge" id="mood-range">giorno</span></div>
      </div>

      <div class="panel">
        <h3>üôèüèº Gratitudine (3)</h3>
        <div class="grid3">
          <input class="in grat" placeholder="1.">
          <input class="in grat" placeholder="2.">
          <input class="in grat" placeholder="3.">
        </div>
      </div>

      <div class="panel">
        <h3>üå™Ô∏è Contatto da ricordare</h3>
        <div class="grid2">
          <input id="contact-name" class="in" placeholder="Nome amico/parente‚Ä¶">
          <input id="contact-file" class="in" type="file" multiple>
        </div>
      </div>
    </section>

    <!-- FITNESS -->
    <section id="fitness" class="view" aria-label="Fitness e Salute">
      <div class="head"><button class="back" data-back>‚Üê</button><div class="title">üí™üèº Fitness & Salute</div></div>
      <div class="ai">"Il corpo √® il tempio dell‚Äôanima. Un passo alla volta!"</div>

      <div class="panel">
        <h3>üíß Contatori Giornalieri</h3>
        <div class="grid3">
          <div class="panel"><div>üíß Idratazione</div><div id="water-count" style="font-size:24px;font-weight:800;margin:8px 0">0</div><div><button data-counter="water" data-delta="-1">‚àí</button> <button data-counter="water" data-delta="1">+</button></div></div>
          <div class="panel"><div>üö≠ Sigarette</div><div id="cig-count" style="font-size:24px;font-weight:800;margin:8px 0">0</div><div><button data-counter="cig" data-delta="-1">‚àí</button> <button data-counter="cig" data-delta="1">+</button></div></div>
          <div class="panel"><div>üç∑ Alcol</div><div id="alcohol-count" style="font-size:24px;font-weight:800;margin:8px 0">0</div><div><button data-counter="alcohol" data-delta="-1">‚àí</button> <button data-counter="alcohol" data-delta="1">+</button></div></div>
        </div>
      </div>

      <div class="panel">
        <h3>üò¥ Sonno / üßò‚Äç‚ôÄÔ∏è Stretching / üíä Integratori</h3>
        <div class="grid3">
          <input id="sleep-hours" class="in" inputmode="decimal" placeholder="Ore di sonno">
          <input id="stretch-min" class="in" inputmode="decimal" placeholder="Minuti stretching/yoga">
          <input id="pills" class="in" placeholder="Farmaci/integratori">
        </div>
      </div>

      <!-- Nutrizione -->
      <div class="panel">
        <h3>üçΩÔ∏è Nutrizione & kcal</h3>
        <div class="grid2"><input class="in meal" data-name="Colazione" placeholder="Colazione"><input class="in kcal" inputmode="decimal" placeholder="kcal"></div>
        <div class="grid2"><input class="in meal" data-name="Spuntino" placeholder="Spuntino"><input class="in kcal" inputmode="decimal" placeholder="kcal"></div>
        <div class="grid2"><input class="in meal" data-name="Pranzo" placeholder="Pranzo"><input class="in kcal" inputmode="decimal" placeholder="kcal"></div>
        <div class="grid2"><input class="in meal" data-name="Merenda" placeholder="Merenda"><input class="in kcal" inputmode="decimal" placeholder="kcal"></div>
        <div class="grid2"><input class="in meal" data-name="Cena" placeholder="Cena"><input class="in kcal" inputmode="decimal" placeholder="kcal"></div>
        <div class="grid2"><input class="in meal" data-name="Spuntino sera" placeholder="Spuntino sera"><input class="in kcal" inputmode="decimal" placeholder="kcal"></div>
        <div class="row"><span>Totale oggi</span><strong><span id="kcal-tot">0</span> kcal</strong></div>
      </div>

      <!-- Spesa & ricette AI -->
      <div class="panel">
        <h3>üõí Spesa & Ricette (AI)</h3>
        <input id="ing-list" class="in" placeholder="Scrivi ingredienti separati da virgola‚Ä¶">
        <div class="grid2" style="margin-top:8px">
          <input id="ing-file" type="file" class="in">
          <button id="ai-recipes" class="btn">Suggerisci ricette (AI)</button>
        </div>
        <div id="recipes-out" class="panel" style="margin-top:8px"></div>
        <div class="small">Per OCR delle foto serve un backend/servizio esterno. Qui l‚ÄôAI usa solo il testo degli ingredienti.</div>
      </div>

      <!-- Workout AI -->
      <div class="panel">
        <h3>üèãÔ∏è Workout (AI)</h3>
        <div class="grid3">
          <input id="w-goal" class="in" placeholder="Obiettivo (es. forza)">
          <input id="w-days" class="in" inputmode="numeric" placeholder="Giorni/settimana (es. 3)">
          <button id="w-generate" class="btn">Genera piano</button>
        </div>
        <div id="workout-out" class="panel" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- SPIRITUALIT√Ä -->
    <section id="spirituality" class="view" aria-label="Spiritualit√†">
      <div class="head"><button class="back" data-back>‚Üê</button><div class="title">üîÆ Spiritualit√†</div></div>
      <div class="panel" style="text-align:center">
        <h3>üßò‚Äç‚ôÄÔ∏è Meditazione Guidata</h3>
        <div id="med-timer" style="font-size:32px;font-weight:800;color:var(--p1);margin:8px 0">05:00</div>
        <button id="med-toggle" class="btn" style="width:auto">‚ñ∂Ô∏è Avvia/Metti in pausa</button>
      </div>

      <div class="panel">
        <h3>ü™ê Tema natale (AI)</h3>
        <div class="grid3">
          <input id="astro-date" class="in" placeholder="10 lug 2004">
          <input id="astro-time" class="in" placeholder="05:00">
          <input id="astro-place" class="in" placeholder="Broni, (PV)">
        </div>
        <button id="astro-analyze" class="btn" style="margin-top:8px;width:100%">Analizza influenza su azioni & umore</button>
        <div id="astro-out" class="panel" style="margin-top:8px">‚Äî</div>
        <div class="small">Per un calcolo astronomico preciso servono effemeridi; qui l‚ÄôAI crea una lettura personalizzata dai tuoi dati.</div>
      </div>

      <div class="panel">
        <h3>üÉè Carta del giorno</h3>
        <div class="row"><span id="tarot">Tocca per pescare‚Ä¶</span><button id="tarot-btn" class="btn">Pesca</button></div>
      </div>

      <div class="panel">
        <h3>üïØÔ∏è Rituale / üìø Sogni / üé∂ Playlist / üé® Doodle</h3>
        <div class="grid2">
          <textarea id="ritual" rows="3" class="in" placeholder="Rituale personale‚Ä¶"></textarea>
          <textarea id="dreams" rows="3" class="in" placeholder="Sogni ricordati‚Ä¶"></textarea>
        </div>
        <div class="grid2" style="margin-top:8px">
          <input id="playlist" class="in" placeholder="Link playlist del giorno">
          <input id="watch" class="in" placeholder="Film/libri/serie da vedere">
        </div>
        <div style="margin-top:8px">
          <canvas id="doodle" width="340" height="180" style="background:#111;border:1px solid #333;border-radius:10px;touch-action:none"></canvas>
          <button id="doodle-save" class="btn" style="margin-top:8px">Scarica disegno</button>
        </div>
        <div style="margin-top:8px">
          <input id="inspo" class="in" placeholder="üñåÔ∏è Ispirazione creativa">
        </div>
      </div>
    </section>

    <!-- COMMUNITY -->
    <section id="community" class="view" aria-label="Community">
      <div class="head"><button class="back" data-back>‚Üê</button><div class="title">ü´Ç Community</div></div>
      <div class="ai">"Insieme siamo pi√π forti!"</div>

      <div class="panel">
        <h3>‚ú® Condividi il tuo momento</h3>
        <textarea rows="3" class="in" id="post-text" placeholder="Cosa stai pensando oggi?"></textarea>
        <div class="row">
          <span>Allega üì∑ üéØ üí°</span>
          <button id="post-btn" class="btn">Pubblica</button>
        </div>
      </div>

      <div class="panel" id="feed">
        <h3>üì∞ Feed</h3>
        <div class="row"><span>@MindfulSara</span><span>‚ÄúPrima meditazione di 20‚Äô fatta! üßò‚Äç‚ôÄÔ∏è‚Äù</span></div>
        <div class="row"><span>@FitnessMarco</span><span>‚Äú10.000 passi al giorno ‚úÖ‚Äù</span></div>
      </div>
    </section>

    <!-- PROFILO -->
    <section id="profile" class="view" aria-label="Profilo">
      <div class="head"><button class="back" data-back>‚Üê</button><div class="title">ü´Ü Profilo</div></div>
      <div class="ai">"Il tuo profilo √® la mappa del tuo universo."</div>

      <div class="panel">
        <h3>üë§ Info</h3>
        <div class="grid2">
          <input class="in" value="Alessandro" placeholder="Nome">
          <input class="in" value="Rossi" placeholder="Cognome">
          <input class="in" value="alex@mindflow.app" placeholder="Email">
          <input class="in" type="date" value="1995-03-15">
        </div>
      </div>

      <div class="panel">
        <h3>üíé Piani & Upgrade</h3>
        <div class="grid3">
          <a class="btn" href="https://buy.stripe.com/cNicN53Lp5WW46y6Y1d0Q03" target="_blank" rel="noopener noreferrer">üå± Boccioli ‚Ç¨7,99/m</a>
          <a class="btn" href="https://buy.stripe.com/5kQeVd6XBCLj8W05TXd0Q04" target="_blank" rel="noopener noreferrer">üå∏ Fiori ‚Ç¨12,99/m</a>
          <a class="btn" href="https://buy.stripe.com/00w7sL3Lpclj3Cucild0Q05" target="_blank" rel="noopener noreferrer">üíé Premium ‚Ç¨149,99/m</a>
        </div>
        <div class="small" style="margin-top:6px">Clicca un piano per aprire il checkout sicuro Stripe.</div>
      </div>
    </section>
  </main>

  <nav class="bottom" aria-label="Navigazione">
    <button class="homebtn" id="go-home" aria-label="Home">üè†</button>
    <button class="sys" id="open-system" aria-haspopup="dialog">Sistema ‚öôÔ∏è</button>
  </nav>
</div>

<!-- Bolla Jindi -->
<button class="jindi" id="jindi" aria-controls="chat" aria-expanded="false">üëã</button>

<!-- Chat -->
<section class="chat" id="chat" aria-live="polite" aria-label="Chat con Jindi">
  <div class="chathead">
    <div style="width:30px;height:30px;border-radius:50%;background:linear-gradient(135deg,var(--p1),var(--p2));display:flex;align-items:center;justify-content:center">üëã</div>
    <div><strong>Jindi AI</strong><div style="font-size:10px;opacity:.7">Il tuo assistente</div></div>
    <button id="close-chat" style="margin-left:auto;background:none;border:0;color:#ccc;font-size:18px">√ó</button>
  </div>
  <div class="msgs" id="msgs"><div class="msg ai">Ciao! Come posso aiutarti oggi? üåü</div></div>
  <input id="chat-in" class="in" placeholder="Scrivi a Jindi‚Ä¶" />
</section>

<script>
/* ===== helpers & nav ===== */
const $ = (s, r=document)=>r.querySelector(s);
const $$ = (s, r=document)=>[...r.querySelectorAll(s)];
const views = ["home","career","emotions","fitness","spirituality","community","profile"];
function show(v){ views.forEach(x=>$("#"+x).classList.toggle("active", x===v)); location.hash="#"+v; }
window.addEventListener("hashchange", ()=>{ const v=(location.hash||"#home").slice(1); show(views.includes(v)?v:"home"); });
$$("#home .card").forEach(b=>b.addEventListener("click", ()=>show(b.dataset.view)));
$$("[data-back]").forEach(b=>b.addEventListener("click", ()=>history.back()));
$("#go-home").addEventListener("click", ()=>show("home"));
$("#open-system").addEventListener("click", ()=>alert("Impostazioni, Backup, Supporto, Info App"));

/* ===== Planner 00:00 ‚Üí 24:00 step 30‚Äô ===== */
(function buildPlanner(){
  const host=$("#planner");
  const times=[];
  for(let h=0; h<24; h++){
    for(let m=0; m<60; m+=30){
      const t=String(h).padStart(2,"0")+":"+String(m).padStart(2,"0");
      times.push(t);
    }
  }
  times.forEach(t=>{
    const row=document.createElement("div");
    row.className="row";
    row.innerHTML = `
      <span style="min-width:64px;display:inline-block">${t}</span>
      <input class="in slot" data-time="${t}" placeholder="Aggiungi azione per ${t}">
      <button class="badge done" data-time="${t}" title="Completa">‚úÖ</button>
    `;
    host.appendChild(row);
  });
  host.addEventListener("click", e=>{
    if(e.target.classList.contains("done")){
      const t=e.target.dataset.time;
      const inp=document.querySelector(\`.slot[data-time="\${t}"]\`);
      if(!inp.value.trim()) return;
      inp.style.textDecoration = inp.style.textDecoration? "" : "line-through";
    }
  });
})();

/* Priorit√† */
$("#prio-add")?.addEventListener("click", ()=>{
  const t=$("#prio-text").value.trim(); if(!t) return;
  const list=$("#prio-list");
  if(list.children.length>=3) return alert("Max 3 priorit√†!");
  const r=document.createElement("div"); r.className="row"; r.innerHTML=`<span>‚ö†Ô∏è ${t}</span><button class="badge">‚úì</button>`;
  r.querySelector("button").onclick=()=>r.remove();
  list.appendChild(r);
  $("#prio-text").value="";
});

/* Mini liste varie */
$("#todo-add")?.addEventListener("click", ()=>{
  const s = (id)=>$("#"+id).value.trim();
  const data = { shop:s("todo-shop"), home:s("todo-home"), comm:s("todo-comm"), deadline:s("todo-deadline") };
  const wrap=$("#todo-lists"); wrap.innerHTML="";
  Object.entries(data).forEach(([k,v])=>{
    if(!v) return;
    const r=document.createElement("div"); r.className="row"; r.innerHTML=`<span>${v}</span><button class="badge">‚úì</button>`;
    r.querySelector("button").onclick=()=>r.remove();
    wrap.appendChild(r);
  });
});

/* Bilancio */
const money = { in:0, out:0 };
$("#cash-add")?.addEventListener("click", ()=>{
  const d=$("#cash-desc").value.trim();
  const inc=parseFloat($("#cash-in").value||"0")||0;
  const out=parseFloat($("#cash-out").value||"0")||0;
  if(!d && !inc && !out) return;
  if(inc) money.in+=inc;
  if(out) money.out+=out;
  const row=document.createElement("div"); row.className="row";
  row.innerHTML=`<span>${d||"‚Äî"}</span><span>${inc?("‚Ç¨+"+inc.toFixed(2)):""} ${out?("‚Ç¨-"+out.toFixed(2)):""}</span>`;
  $("#cash-list").appendChild(row);
  $("#cash-in-tot").textContent=money.in.toFixed(2);
  $("#cash-out-tot").textContent=money.out.toFixed(2);
  $("#cash-desc").value=$("#cash-in").value=$("#cash-out").value="";
});

/* Calcolo rapido (solo lordo) */
const hours=$("#hours"), rate=$("#rate"), gross=$("#gross");
function calc(){ const h=parseFloat(hours?.value||0)||0; const r=parseFloat(rate?.value||0)||0; const g=h*r; gross.textContent=g.toFixed(2); }
hours?.addEventListener("input", calc); rate?.addEventListener("input", calc);

/* EMOZIONI: registro + grafico minimo */
const moodDataDay=[], moodDataWeek=[];
function drawChart(){
  const c=$("#mood-chart"); const ctx=c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle="#aaa"; ctx.textBaseline="top"; ctx.font="12px system-ui";
  const mode=$("#mood-range").textContent.includes("giorno")?"day":"week";
  const data= mode==="day"? moodDataDay : moodDataWeek;
  if(!data.length){ ctx.fillText("Nessun dato", 10, 10); return; }
  const maxX=c.width-20, maxY=c.height-20;
  const stepX = maxX/Math.max(1,data.length-1);
  ctx.strokeStyle="#fff"; ctx.beginPath();
  data.forEach((v,i)=>{
    const x=10+i*stepX, y=maxY-(v-1)/9*maxY; // v=1..10
    if(i) ctx.lineTo(x,y); else ctx.moveTo(x,y);
  });
  ctx.stroke();
}
$("#mood-add")?.addEventListener("click", ()=>{
  const v=parseInt($("#mood-int").value,10);
  const time=$("#mood-time").value, emo=$("#mood-emo").value, trg=$("#mood-trigger").value, sc=$("#mood-selfcare").value;
  const row=document.createElement("div"); row.className="row";
  row.innerHTML=`<span>${time} ${emo} (int. ${v})</span><span class="small">${trg||"‚Äî"} | ${sc||"‚Äî"}</span>`;
  $("#mood-list").appendChild(row);
  moodDataDay.push(v); if(moodDataDay.length>16) moodDataDay.shift();
  moodDataWeek.push(v); if(moodDataWeek.length>56) moodDataWeek.shift();
  drawChart();
});
$("#mood-range")?.addEventListener("click", e=>{
  e.target.textContent = e.target.textContent==="giorno" ? "settimana" : "giorno";
  drawChart();
});

/* FITNESS: contatori & kcal */
const counters={water:$("#water-count"), cig:$("#cig-count"), alcohol:$("#alcohol-count")};
$$("[data-counter]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const n=btn.dataset.counter; const d=parseInt(btn.dataset.delta,10);
    const el=counters[n]; let v=parseInt(el.textContent||"0",10)+d; el.textContent=Math.max(0,v);
  });
});
function sumKcal(){ let tot=0; $$(".kcal").forEach(i=>{ const v=parseFloat(i.value||"0")||0; tot+=v; }); $("#kcal-tot").textContent=tot; }
$$(".kcal").forEach(i=>i.addEventListener("input", sumKcal));

/* Spesa/ricette AI */
$("#ai-recipes")?.addEventListener("click", async ()=>{
  const ingredients=$("#ing-list").value.trim();
  $("#recipes-out").textContent="Sto pensando a ricette‚Ä¶";
  try{
    const r=await fetch("/api/recipes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ingredients})});
    if(!r.ok) throw new Error(await r.text());
    const d=await r.json();
    $("#recipes-out").textContent=d.text||"‚Äî";
  }catch(e){ console.error(e); $("#recipes-out").textContent="Ops, non riesco ora üôè"; }
});

/* Workout AI */
$("#w-generate")?.addEventListener("click", async ()=>{
  const goal=$("#w-goal").value.trim()||"Forza"; const days=$("#w-days").value.trim()||"3";
  $("#workout-out").textContent="Creo il tuo piano‚Ä¶";
  try{
    const r=await fetch("/api/workout",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({goal,days})});
    if(!r.ok) throw new Error(await r.text());
    const d=await r.json(); $("#workout-out").textContent=d.text||"‚Äî";
  }catch(e){ console.error(e); $("#workout-out").textContent="Ops, non riesco ora üôè"; }
});

/* Meditazione */
const medBtn=$("#med-toggle"), medTimer=$("#med-timer"); let secs=5*60, iv=null;
function rend(){const m=Math.floor(secs/60), s=secs%60; medTimer.textContent=String(m).padStart(2,"0")+":"+String(s).padStart(2,"0");}
function start(){ if(iv) return; iv=setInterval(()=>{ if(secs>0){secs--;rend();}else{stop();secs=5*60;rend();alert("Meditazione completata ‚ú®");}},1000); }
function stop(){ clearInterval(iv); iv=null; }
medBtn?.addEventListener("click", ()=> iv?stop():start()); rend();

/* Astro AI */
$("#astro-analyze")?.addEventListener("click", async ()=>{
  $("#astro-out").textContent="Analizzo‚Ä¶";
  const date=$("#astro-date").value.trim(), time=$("#astro-time").value.trim(), place=$("#astro-place").value.trim();
  try{
    const r=await fetch("/api/astro",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({date,time,place})});
    if(!r.ok) throw new Error(await r.text());
    const d=await r.json(); $("#astro-out").textContent=d.text||"‚Äî";
  }catch(e){ console.error(e); $("#astro-out").textContent="Ops, non riesco ora üôè"; }
});

/* Tarot semplice */
const TAROT=["Il Matto","Il Bagatto","La Papessa","L‚ÄôImperatrice","L‚ÄôImperatore","Il Papa","Gli Amanti","Il Carro","La Giustizia","L‚ÄôEremita","La Ruota","La Forza","L‚ÄôAppeso","La Morte","La Temperanza","Il Diavolo","La Torre","Le Stelle","La Luna","Il Sole","Il Giudizio","Il Mondo"];
$("#tarot-btn")?.addEventListener("click", ()=>{ const c=TAROT[Math.floor(Math.random()*TAROT.length)]; $("#tarot").textContent="üÉè "+c; });

/* Doodle */
(function(){
  const c=$("#doodle"); if(!c) return;
  const ctx=c.getContext("2d"); let drawing=false, lx=0, ly=0;
  function p(e){const r=c.getBoundingClientRect(); return {x:(e.touches?e.touches[0].clientX:e.clientX)-r.left, y:(e.touches?e.touches[0].clientY:e.clientY)-r.top};}
  function down(e){drawing=true; const a=p(e); lx=a.x; ly=a.y;}
  function move(e){if(!drawing) return; const a=p(e); ctx.strokeStyle="#fff"; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(lx,ly); ctx.lineTo(a.x,a.y); ctx.stroke(); lx=a.x; ly=a.y;}
  function up(){drawing=false;}
  ["mousedown","touchstart"].forEach(ev=>c.addEventListener(ev,down)); 
  ["mousemove","touchmove"].forEach(ev=>c.addEventListener(ev,move)); 
  ["mouseup","mouseleave","touchend","touchcancel"].forEach(ev=>c.addEventListener(ev,up));
  $("#doodle-save")?.addEventListener("click",()=>{ const a=document.createElement("a"); a.href=c.toDataURL("image/png"); a.download="doodle.png"; a.click(); });
})();

/* Community mock */
$("#post-btn")?.addEventListener("click", ()=>{
  const t=$("#post-text").value.trim(); if(!t) return;
  const row=document.createElement("div"); row.className="row";
  row.innerHTML=`<span>@Tu</span><span>${t}</span>`;
  $("#feed").appendChild(row); $("#post-text").value="";
  alert("Pubblicato nella community ‚ú®");
});

/* Chat AI minimale */
const bubble=$("#jindi"), chat=$("#chat"), closeChat=$("#close-chat"), input=$("#chat-in"), msgs=$("#msgs");
function toggleChat(open){ const isOpen=open??!chat.classList.contains("active"); chat.classList.toggle("active", isOpen); bubble.setAttribute("aria-expanded", String(isOpen)); if(isOpen) input.focus(); }
bubble?.addEventListener("click", ()=>toggleChat()); closeChat?.addEventListener("click", ()=>toggleChat(false));
function addMsg(text, who="ai"){ const d=document.createElement("div"); d.className="msg "+who; d.textContent=text; msgs.appendChild(d); msgs.scrollTop=msgs.scrollHeight; }
async function generateAIResponse(userMessage){
  try{
    const r = await fetch("/api/chat", {method:"POST",headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ message: userMessage })});
    if(!r.ok) throw new Error(await r.text()); const data = await r.json();
    return data.reply || "Sto riflettendo‚Ä¶ ‚ú®";
  }catch(e){ console.error(e); return "Ops, non riesco a rispondere ora. Riprova tra poco üôè"; }
}
input?.addEventListener("keydown", async e=>{
  if(e.key==="Enter"){
    const text=input.value.trim(); if(!text) return;
    addMsg(text,"me"); input.value="";
    const reply = await generateAIResponse(text);
    addMsg(reply,"ai");
  }
});

/* Start */
show((location.hash||"#home").slice(1));
</script>
</body>
</html>
